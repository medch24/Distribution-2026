<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Distribution Annuelle 2025-2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.6/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Le script socket.io.js a été supprimé car il n'est plus utilisé -->
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; color: #333; text-align: center; padding: 20px; }
        h1 { color: #2a5d9f; font-size: 32px; margin-bottom: 30px; }
        button { font-size: 18px; margin: 10px 5px; padding: 10px 20px; border: none; background-color: #4CAF50; color: white; cursor: pointer; border-radius: 5px; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        .section-classes { display: none; margin-top: 20px; }
        .section-classes button { margin: 5px; padding: 8px 15px; font-size: 16px; }
        #initialSelection {}
        #classView { display: none; margin-top: 30px; text-align: left; }
        #classView h1 { text-align: center; font-size: 24px; }
        label, select, input[type="checkbox"] { font-size: 16px; margin: 10px 5px; display: inline-block; vertical-align: middle; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; vertical-align: middle; }
        button { vertical-align: middle; }
        .table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; min-width: 1200px; border-collapse: collapse; margin: 20px 0; background-color: #ffffff; table-layout: fixed; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; font-size: 12px; word-wrap: break-word; vertical-align: top; }
        th { background-color: #2a5d9f; color: white; font-weight: bold; position: sticky; top: 0; z-index: 1; }
        .merged-cell { font-weight: bold; text-align: center; vertical-align: middle; color: #333; }
        .modifiable-input { width: calc(100% - 16px); min-height: 80px; padding: 8px; border-radius: 5px; resize: vertical; font-size: 12px; box-sizing: border-box; display: block; margin: 0; border: 1px solid #ccc; }
        th:nth-child(1), td:nth-child(1) { width: 45px; } th:nth-child(2), td:nth-child(2) { width: 45px; } th:nth-child(3), td:nth-child(3) { width: 45px; text-align: center; }
        #progressBar { width: 100%; height: 20px; background-color: #f3f3f3; border: 1px solid #ddd; display: none; position: relative; margin: 20px 0; }
        #progressBar div { height: 100%; width: 0; background-color: #4CAF50; transition: width 0.4s ease-in-out; }
    </style>
</head>
<body>
<div id="initialSelection">
    <h1>Distribution Annuelle 2025-2026</h1>
    <button onclick="showClasses('maternelle')">Section Maternelle</button>
    <button onclick="showClasses('primaire')">Section Primaire</button>
    <button onclick="showClasses('secondaire')">Section Secondaire (PEI et P. Diplôme)</button>
    <div id="maternelle" class="section-classes">
        <button onclick="goToClass('TPS')">TPS</button><button onclick="goToClass('PS')">PS</button><button onclick="goToClass('MS')">MS</button><button onclick="goToClass('GS')">GS</button>
    </div>
    <div id="primaire" class="section-classes">
        <button onclick="goToClass('PP1')">PP1</button><button onclick="goToClass('PP2')">PP2</button><button onclick="goToClass('PP3')">PP3</button><button onclick="goToClass('PP4')">PP4</button><button onclick="goToClass('PP5')">PP5</button>
    </div>
    <div id="secondaire" class="section-classes">
        <button onclick="goToClass('PEI1')">PEI1</button><button onclick="goToClass('PEI2')">PEI2</button><button onclick="goToClass('PEI3')">PEI3</button><button onclick="goToClass('PEI4')">PEI4</button><button onclick="goToClass('PEI5')">PEI5</button><button onclick="goToClass('DP1')">DP1</button><button onclick="goToClass('DP2')">DP2</button>
    </div>
</div>
<div id="classView" style="display: none;">
    <h1 id="classTitle"></h1>
    <button onclick="showInitialSelection()" style="background-color: #6c757d;">Changer de Classe</button>
    <div class="button-container" style="margin-bottom: 20px; margin-top: 10px;">
        <button onclick="generateExcel()">Générer Excel (Matière)</button>
        <button onclick="generateWord()">Générer Word (Matière)</button>
        <button onclick="generatePdf()" style="background-color: #c82333;">Générer PDF (Matière)</button>
        <button onclick="generateExcelZipForClass()">Générer Excel (ZIP par Classe)</button>
        <button onclick="generateWordZipForClass()">Générer Word (ZIP par Classe)</button>
        <button onclick="saveTable()">Enregistrer les modifications</button>
        <button onclick="document.getElementById('excelUploadInput').click()" style="background-color: #17a2b8;">Importer Excel</button>
        <input type="file" id="excelUploadInput" style="display: none;" onchange="handleFileUpload(event)" accept=".xlsx, .xls">
        <button onclick="deleteMatiereData()" style="background-color: #dc3545;">Supprimer les données de la matière</button>
    </div>
    <div>
        <label for="matiereSelect">Choisir une matière :</label>
        <select id="matiereSelect" onchange="displaySelectedTable()"><option value="">Sélectionner une matière</option></select>
    </div>
    <div style="margin-top: 20px;">
        <label for="filterBy">Filtrer par :</label>
        <select id="filterBy" onchange="populateFilterOptions()">
            <option value="">Sélectionner un filtre</option>
            <option value="Mois">Mois</option>
            <option value="Semaine">Semaine</option>
        </select>
        <select id="filterOptions" onchange="applyFilter()" style="display: none;"></select>
        <button onclick="clearFilter()" style="background-color: #ffc107;">Annuler le filtre</button>
        <label style="margin-left: 20px;"><input type="checkbox" id="showFilledOnly" onclick="toggleFilledRows()"> Afficher uniquement les lignes remplies</label>
    </div>
    <div id="progressBar"><div></div></div>
    <div class="table-container">
        <div id="output"></div>
    </div>
</div>

<script>
    // ========================================================================
    // === NOUVELLE FAÇON DE COMMUNIQUER AVEC LE SERVEUR VIA HTTP (fetch) ===
    // ========================================================================
    async function apiRequest(endpoint, body) {
        try {
            const response = await fetch(`/api/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: response.statusText }));
                console.error(`Erreur API pour ${endpoint}:`, errorData);
                return { success: false, error: errorData.error || `Erreur HTTP: ${response.status}` };
            }
            return response.json();
        } catch (error) {
            console.error(`Erreur réseau pour ${endpoint}:`, error);
            return { success: false, error: 'Erreur de connexion au serveur.' };
        }
    }

    // Vérification de la version pour le rafraîchissement
    fetch('/api/appVersion').then(res => res.json()).then(data => {
        const serverVersion = data.version;
        const localVersion = localStorage.getItem('appVersion');
        if (localVersion && localVersion != serverVersion) {
            console.log('Nouvelle version du serveur détectée. Rafraîchissement...');
            location.reload(true);
        }
        localStorage.setItem('appVersion', serverVersion);
    }).catch(err => console.error("Impossible de vérifier la version de l'app:", err));

    let currentClass = null; let savedData = {};
    const standardHeaders = ["Mois", "Semaine", "Date", "Jour", "Unité/Chapitre", "Contenu de la leçon", "Ressources pour les leçons", "Devoir", "Ressources pour les devoirs", "Recherche", "Projets"];
    const monthAbbreviations = { 'Janvier': 'Janv.', 'Février': 'Févr.', 'Mars': 'Mars', 'Avril': 'Avr.', 'Mai': 'Mai', 'Juin': 'Juin', 'Juillet': 'Juil.', 'août': 'Août', 'septembre': 'Sept.', 'octobre': 'Oct.', 'novembre': 'Nov.', 'décembre': 'Déc.' }; 
    const classSubjects = { 'TPS': ['Français', 'Maths', 'Sciences', 'ART', 'Éducation physique', 'Montessori', 'Musique', 'Bibliothèque'],'PS': ['Français', 'Maths', 'Sciences', 'ART', 'Éducation physique', 'Montessori', 'Musique', 'Bibliothèque'],'MS': ['Français', 'Maths', 'Sciences', 'Informatique', 'ART', 'Éducation physique', 'Montessori', 'Musique', 'Bibliothèque'],'GS': ['Français', 'Maths', 'Sciences', 'Informatique', 'ART', 'Éducation physique', 'Montessori', 'Musique', 'Bibliothèque'],'PP1': ['Français', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences Naturelles', 'Sciences Humaines', 'ART', 'Éducation physique', 'Montessori', 'Musique', 'Bibliothèque'], 'PP2': ['Français', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences Naturelles', 'Sciences Humaines', 'ART', 'Éducation physique', 'Montessori', 'Musique', 'Bibliothèque'],'PP3': ['Français', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences Naturelles', 'Sciences Humaines', 'ART', 'Éducation physique', 'Montessori', 'Musique', 'Bibliothèque'], 'PP4': ['Français', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences humaines', 'Sciences naturelles', 'ART', 'Éducation physique', 'Musique', 'Bibliothèque'], 'PP5': ['Français', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences Naturelles', 'Sciences Humaines', 'ART', 'Éducation physique', 'Musique', 'Bibliothèque'], 'PEI1': ['Langue et littérature', 'Maths', 'Sciences', 'Anglais', 'French second language', 'Design', 'Individus et Sociétés', 'ART', 'Éducation physique', 'Musique', 'Bibliothèque'], 'PEI2': ['Maths', 'Langue et littérature', 'Anglais', 'French second language', 'Biologie', 'Design', 'Individus et Sociétés', 'Physique-chimie', 'ART', 'Éducation physique', 'Musique', 'Bibliothèque'], 'PEI3': ['Maths', 'Langue et littérature', 'Anglais', 'French second language', 'Biologie', 'Design', 'Individus et Sociétés', 'Physique-chimie', 'ART', 'Éducation physique', 'Musique', 'Bibliothèque'], 'PEI4': ['Maths', 'Biologie', 'Langue et littérature', 'Anglais', 'Design', 'Individus et Sociétés', 'Physique-chimie', 'ART', 'Éducation physique', 'Musique', 'Bibliothèque'],'PEI5': ['Maths', 'Biologie', 'Individus et Sociétés', 'Langue et littérature', 'Physique-chimie', 'Anglais', 'Sciences Économiques et Sociales', 'Sciences numeriques et Technologies', 'ART', 'Éducation physique', 'Musique', 'Bibliothèque'],'DP1': ['Biologie', 'Maths', 'Individus et Sociétés', 'Anglais', 'Langue et littérature', 'Physique-chimie', 'Sciences Économiques', 'Éducation physique', 'ART', 'Bibliothèque', 'Enseignement Scientifique'],'DP2': ['Langue et littérature', 'Maths', 'Biologie', 'Individus et Sociétés', 'Physique-chimie', 'Anglais', 'Histoire', 'Éducation physique', 'ART', 'Bibliothèque', 'Enseignement Scientifique'] }; 
    const classSessionCounts = { 'TPS': { 'ART': 2, 'Français': 7, 'Maths': 5, 'Montessori': 2, 'Musique': 1, 'Éducation physique': 2, 'Sciences': 5 }, 'PS': { 'ART': 2, 'Français': 7, 'Maths': 5, 'Montessori': 2, 'Musique': 1, 'Éducation physique': 2, 'Sciences': 5 }, 'MS': { 'ART': 2, 'Français': 7, 'Maths': 5, 'Montessori': 2, 'Musique': 1, 'Éducation physique': 2, 'Sciences': 5, 'Informatique': 2 }, 'GS': { 'ART': 2, 'Bibliothèque': 1, 'Français': 9, 'Informatique': 2, 'Maths': 5, 'Montessori': 2, 'Musique': 1, 'Éducation physique': 2, 'Sciences': 5 }, 'PP1': { 'Français': 8, 'Maths': 5, 'Anglais': 3, 'French second language': 2, 'Sciences Naturelles': 3, 'ART': 2, 'Éducation physique': 2, 'Sciences Humaines': 2, 'Bibliothèque': 1, 'Informatique': 1, 'Montessori': 1, 'Musique': 1 },'PP2': { 'Français': 8, 'Maths': 5, 'Anglais': 3, 'French second language': 2, 'Sciences Naturelles': 3, 'ART': 2, 'Éducation physique': 2, 'Sciences Humaines': 2, 'Bibliothèque': 1, 'Informatique': 1, 'Montessori': 1, 'Musique': 1 },'PP3': { 'Français': 8, 'Maths': 5, 'Anglais': 3, 'French second language': 2, 'Sciences Humaines': 3, 'ART': 2, 'Éducation physique': 2, 'Sciences Naturelles': 2, 'Bibliothèque': 1, 'Informatique': 1, 'Montessori': 1, 'Musique': 1 },'PP4': { 'Français': 9, 'Maths': 5, 'Anglais': 3, 'French second language': 2, 'Sciences humaines': 3, 'Éducation physique': 2, 'Sciences naturelles': 2, 'ART': 2, 'Bibliothèque': 1, 'Informatique': 1, 'Musique': 1 },'PP5': { 'Français': 9, 'Maths': 5, 'Anglais': 3, 'French second language': 2, 'Sciences Humaines': 3, 'ART': 2, 'Éducation physique': 2, 'Sciences Naturelles': 2, 'Bibliothèque': 1, 'Informatique': 1, 'Musique': 1 },'PEI1':{ 'Langue et littérature': 6, 'Maths': 5, 'Sciences': 4, 'Anglais': 3, 'French second language': 2, 'Design': 3, 'Individus et Sociétés': 3, 'ART': 2, 'Éducation physique': 2, 'Bibliothèque': 1, 'Musique': 1 },'PEI2':{'Maths': 5, 'Langue et littérature': 4, 'Anglais': 3, 'French second language': 2, 'Biologie': 3, 'Design': 3, 'Individus et Sociétés': 3, 'ART': 2, 'Physique-chimie': 2, 'Éducation physique': 2, 'Bibliothèque': 1, 'Musique': 1 },'PEI3':{ 'Maths': 5, 'Langue et littérature': 4, 'Anglais': 3, 'French second language': 2, 'Biologie': 3, 'Design': 3, 'Individus et Sociétés': 3, 'ART': 2, 'Éducation physique': 2, 'Physique-chimie': 2, 'Bibliothèque': 1, 'Musique': 1 },'PEI4':{ 'Maths': 5, 'Biologie': 4, 'Langue et littérature': 4, 'Anglais': 3, 'Design': 3, 'Individus et Sociétés': 3, 'ART': 2, 'Éducation physique': 2, 'Physique-chimie': 2, 'Bibliothèque': 1, 'Musique': 1 }, 'PEI5':{ 'Maths': 5, 'Biologie': 4, 'Individus et Sociétés': 4, 'Langue et littérature': 4, 'Physique-chimie': 4, 'Anglais': 3, 'ART': 2, 'Éducation physique': 2, 'Bibliothèque': 1, 'Musique': 1, 'Sciences Économiques et Sociales': 1, 'Sciences numeriques et Technologies': 1 }, 'DP1': { 'Biologie': 5, 'Maths': 5, 'Individus et Sociétés': 4, 'Anglais': 3, 'Langue et littérature': 3, 'Physique-chimie': 3, 'Éducation physique': 2, 'Sciences Économiques': 2, 'ART': 1, 'Bibliothèque': 1, 'Enseignement Scientifique': 1 }, 'DP2': { 'Langue et littérature': 5, 'Maths': 5, 'Biologie': 4, 'Individus et Sociétés': 4, 'Physique-chimie': 4, 'Anglais': 3, 'Éducation physique': 2, 'Histoire': 2, 'ART': 1, 'Bibliothèque': 1, 'Enseignement Scientifique': 1 } }; 

    // NOUVEAU CALENDRIER OFFICIEL
    const academicCalendar = [ { month: 'août', week: 1, date: '31/08/2025', day: 'dimanche', type: 'Orientation' }, { month: 'septembre', week: 1, date: '01/09/2025', day: 'lundi', type: 'Orientation' }, { month: 'septembre', week: 1, date: '02/09/2025', day: 'mardi', type: 'Orientation' }, { month: 'septembre', week: 1, date: '03/09/2025', day: 'mercredi', type: 'Orientation' }, { month: 'septembre', week: 1, date: '04/09/2025', day: 'jeudi', type: 'Orientation' }, { month: 'septembre', week: 2, date: '07/09/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'septembre', week: 2, date: '08/09/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'septembre', week: 2, date: '09/09/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'septembre', week: 2, date: '10/09/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'septembre', week: 2, date: '11/09/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'septembre', week: 3, date: '14/09/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'septembre', week: 3, date: '15/09/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'septembre', week: 3, date: '16/09/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'septembre', week: 3, date: '17/09/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'septembre', week: 3, date: '18/09/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'septembre', week: 4, date: '21/09/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'septembre', week: 4, date: '22/09/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'septembre', week: 4, date: '23/09/2025', day: 'mardi', type: 'Saudi National day', isFixed: true }, { month: 'septembre', week: 4, date: '24/09/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'septembre', week: 4, date: '25/09/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'septembre', week: 5, date: '28/09/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'septembre', week: 5, date: '29/09/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'septembre', week: 5, date: '30/09/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'octobre', week: 5, date: '01/10/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'octobre', week: 5, date: '02/10/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'octobre', week: 6, date: '05/10/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'octobre', week: 6, date: '06/10/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'octobre', week: 6, date: '07/10/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'octobre', week: 6, date: '08/10/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'octobre', week: 6, date: '09/10/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'octobre', week: 7, date: '12/10/2025', day: 'dimanche', type: 'Long weekend', isFixed: true }, { month: 'octobre', week: 7, date: '13/10/2025', day: 'lundi', type: 'Evaluation' }, { month: 'octobre', week: 7, date: '14/10/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'octobre', week: 7, date: '15/10/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'octobre', week: 7, date: '16/10/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'octobre', week: 8, date: '19/10/2025', day: 'dimanche', type: 'Evaluation' }, { month: 'octobre', week: 8, date: '20/10/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'octobre', week: 8, date: '21/10/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'octobre', week: 8, date: '22/10/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'octobre', week: 8, date: '23/10/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'octobre', week: 9, date: '26/10/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'octobre', week: 9, date: '27/10/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'octobre', week: 9, date: '28/10/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'octobre', week: 9, date: '29/10/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'octobre', week: 9, date: '30/10/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'novembre', week: 10, date: '02/11/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'novembre', week: 10, date: '03/11/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'novembre', week: 10, date: '04/11/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'novembre', week: 10, date: '05/11/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'novembre', week: 10, date: '06/11/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'novembre', week: 11, date: '09/11/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'novembre', week: 11, date: '10/11/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'novembre', week: 11, date: '11/11/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'novembre', week: 11, date: '12/11/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'novembre', week: 11, date: '13/11/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'novembre', week: 12, date: '16/11/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'novembre', week: 12, date: '17/11/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'novembre', week: 12, date: '18/11/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'novembre', week: 12, date: '19/11/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'novembre', week: 12, date: '20/11/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'novembre', week: 'Vacances', date: '23/11/2025', day: 'dimanche', type: 'Vacances', isFixed: true }, { month: 'novembre', week: 'Vacances', date: '24/11/2025', day: 'lundi', type: 'Vacances', isFixed: true }, { month: 'novembre', week: 'Vacances', date: '25/11/2025', day: 'mardi', type: 'Vacances', isFixed: true }, { month: 'novembre', week: 'Vacances', date: '26/11/2025', day: 'mercredi', type: 'Vacances', isFixed: true }, { month: 'novembre', week: 'Vacances', date: '27/11/2025', day: 'jeudi', type: 'Vacances', isFixed: true }, { month: 'novembre', week: 13, date: '30/11/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'décembre', week: 13, date: '01/12/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'décembre', week: 13, date: '02/12/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'décembre', week: 13, date: '03/12/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'décembre', week: 13, date: '04/12/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'décembre', week: 14, date: '07/12/2025', day: 'dimanche', type: 'Cours Normal' }, { month: 'décembre', week: 14, date: '08/12/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'décembre', week: 14, date: '09/12/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'décembre', week: 14, date: '10/12/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'décembre', week: 14, date: '11/12/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'décembre', week: 15, date: '14/12/2025', day: 'dimanche', type: 'Long weekend', isFixed: true }, { month: 'décembre', week: 15, date: '15/12/2025', day: 'lundi', type: 'Cours Normal' }, { month: 'décembre', week: 15, date: '16/12/2025', day: 'mardi', type: 'Cours Normal' }, { month: 'décembre', week: 15, date: '17/12/2025', day: 'mercredi', type: 'Cours Normal' }, { month: 'décembre', week: 15, date: '18/12/2025', day: 'jeudi', type: 'Cours Normal' }, { month: 'décembre', week: 16, date: '21/12/2025', day: 'dimanche', type: 'Révision' }, { month: 'décembre', week: 16, date: '22/12/2025', day: 'lundi', type: 'Révision' }, { month: 'décembre', week: 16, date: '23/12/2025', day: 'mardi', type: 'Révision' }, { month: 'décembre', week: 16, date: '24/12/2025', day: 'mercredi', type: 'Examen Final 1', isFixed: true }, { month: 'décembre', week: 16, date: '25/12/2025', day: 'jeudi', type: 'Examen Final 1', isFixed: true }, { month: 'décembre', week: 'Examen Final 1', date: '28/12/2025', day: 'dimanche', type: 'Examen Final 1', isFixed: true }, { month: 'décembre', week: 'Examen Final 1', date: '29/12/2025', day: 'lundi', type: 'Examen Final 1', isFixed: true }, { month: 'décembre', week: 'Examen Final 1', date: '30/12/2025', day: 'mardi', type: 'Examen Final 1', isFixed: true }, { month: 'décembre', week: 'Examen Final 1', date: '31/12/2025', day: 'mercredi', type: 'Examen Final 1', isFixed: true }, { month: 'janvier', week: 'Examen Final 1', date: '01/01/2026', day: 'jeudi', type: 'Examen Final 1', isFixed: true }, { month: 'janvier', week: 'Examen Final 1', date: '04/01/2026', day: 'dimanche', type: 'Examen Final 1', isFixed: true }, { month: 'janvier', week: 'Examen Final 1', date: '05/01/2026', day: 'lundi', type: 'Examen Final 1', isFixed: true }, { month: 'janvier', week: 'Examen Final 1', date: '06/01/2026', day: 'mardi', type: 'Examen Final 1', isFixed: true }, { month: 'janvier', week: 'Examen Final 1', date: '07/01/2026', day: 'mercredi', type: 'Examen Final 1', isFixed: true }, { month: 'janvier', week: 'Examen Final 1', date: '08/01/2026', day: 'jeudi', type: 'Examen Final 1', isFixed: true }, { month: 'janvier', week: 'Vacances', date: '11/01/2026', day: 'dimanche', type: 'Vacances', isFixed: true }, { month: 'janvier', week: 'Vacances', date: '12/01/2026', day: 'lundi', type: 'Vacances', isFixed: true }, { month: 'janvier', week: 'Vacances', date: '13/01/2026', day: 'mardi', type: 'Vacances', isFixed: true }, { month: 'janvier', week: 'Vacances', date: '14/01/2026', day: 'mercredi', type: 'Vacances', isFixed: true }, { month: 'janvier', week: 'Vacances', date: '15/01/2026', day: 'jeudi', type: 'Vacances', isFixed: true }, { month: 'janvier', week: 17, date: '18/01/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'janvier', week: 17, date: '19/01/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'janvier', week: 17, date: '20/01/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'janvier', week: 17, date: '21/01/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'janvier', week: 17, date: '22/01/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'janvier', week: 18, date: '25/01/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'janvier', week: 18, date: '26/01/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'janvier', week: 18, date: '27/01/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'janvier', week: 18, date: '28/01/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'janvier', week: 18, date: '29/01/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'février', week: 19, date: '01/02/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'février', week: 19, date: '02/02/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'février', week: 19, date: '03/02/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'février', week: 19, date: '04/02/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'février', week: 19, date: '05/02/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'février', week: 20, date: '08/02/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'février', week: 20, date: '09/02/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'février', week: 20, date: '10/02/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'février', week: 20, date: '11/02/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'février', week: 20, date: '12/02/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'février', week: 21, date: '15/02/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'février', week: 21, date: '16/02/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'février', week: 21, date: '17/02/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'février', week: 21, date: '18/02/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'février', week: 21, date: '19/02/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'février', week: 22, date: '22/02/2026', day: 'dimanche', type: 'Saudi foundation day', isFixed: true }, { month: 'février', week: 22, date: '23/02/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'février', week: 22, date: '24/02/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'février', week: 22, date: '25/02/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'février', week: 22, date: '26/02/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'mars', week: 23, date: '01/03/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'mars', week: 23, date: '02/03/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'mars', week: 23, date: '03/03/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'mars', week: 23, date: '04/03/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'mars', week: 23, date: '05/03/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'mars', week: 'Vacances', date: '08/03/2026', day: 'dimanche', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '09/03/2026', day: 'lundi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '10/03/2026', day: 'mardi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '11/03/2026', day: 'mercredi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '12/03/2026', day: 'jeudi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '15/03/2026', day: 'dimanche', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '16/03/2026', day: 'lundi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '17/03/2026', day: 'mardi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '18/03/2026', day: 'mercredi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '19/03/2026', day: 'jeudi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '22/03/2026', day: 'dimanche', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '23/03/2026', day: 'lundi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '24/03/2026', day: 'mardi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '25/03/2026', day: 'mercredi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 'Vacances', date: '26/03/2026', day: 'jeudi', type: 'Vacances', isFixed: true }, { month: 'mars', week: 24, date: '29/03/2026', day: 'dimanche', type: 'Evaluation' }, { month: 'mars', week: 24, date: '30/03/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'mars', week: 24, date: '31/03/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'avril', week: 24, date: '01/04/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'avril', week: 24, date: '02/04/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'avril', week: 25, date: '05/04/2026', day: 'dimanche', type: 'Evaluation' }, { month: 'avril', week: 25, date: '06/04/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'avril', week: 25, date: '07/04/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'avril', week: 25, date: '08/04/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'avril', week: 25, date: '09/04/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'avril', week: 26, date: '12/04/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'avril', week: 26, date: '13/04/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'avril', week: 26, date: '14/04/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'avril', week: 26, date: '15/04/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'avril', week: 26, date: '16/04/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'avril', week: 27, date: '19/04/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'avril', week: 27, date: '20/04/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'avril', week: 27, date: '21/04/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'avril', week: 27, date: '22/04/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'avril', week: 27, date: '23/04/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'avril', week: 28, date: '26/04/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'avril', week: 28, date: '27/04/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'avril', week: 28, date: '28/04/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'avril', week: 28, date: '29/04/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'avril', week: 28, date: '30/04/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'mai', week: 29, date: '03/05/2026', day: 'dimanche', type: 'Cours Normal' }, { month: 'mai', week: 29, date: '04/05/2026', day: 'lundi', type: 'Cours Normal' }, { month: 'mai', week: 29, date: '05/05/2026', day: 'mardi', type: 'Cours Normal' }, { month: 'mai', week: 29, date: '06/05/2026', day: 'mercredi', type: 'Cours Normal' }, { month: 'mai', week: 29, date: '07/05/2026', day: 'jeudi', type: 'Cours Normal' }, { month: 'mai', week: 30, date: '10/05/2026', day: 'dimanche', type: 'Révision' }, { month: 'mai', week: 30, date: '11/05/2026', day: 'lundi', type: 'Révision' }, { month: 'mai', week: 30, date: '12/05/2026', day: 'mardi', type: 'Révision' }, { month: 'mai', week: 30, date: '13/05/2026', day: 'mercredi', type: 'Révision' }, { month: 'mai', week: 30, date: '14/05/2026', day: 'jeudi', type: 'Révision' }, { month: 'mai', week: 'Vacances', date: '17/05/2026', day: 'dimanche', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '18/05/2026', day: 'lundi', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '19/05/2026', day: 'mardi', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '20/05/2026', day: 'mercredi', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '21/05/2026', day: 'jeudi', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '24/05/2026', day: 'dimanche', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '25/05/2026', day: 'lundi', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '26/05/2026', day: 'mardi', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '27/05/2026', day: 'mercredi', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '28/05/2026', day: 'jeudi', type: 'Vacances', isFixed: true }, { month: 'mai', week: 'Vacances', date: '31/05/2026', day: 'dimanche', type: 'Vacances', isFixed: true }, { month: 'juin', week: 'Vacances', date: '01/06/2026', day: 'lundi', type: 'Vacances', isFixed: true }, { month: 'juin', week: 'Vacances', date: '02/06/2026', day: 'mardi', type: 'Vacances', isFixed: true }, { month: 'juin', week: 'Vacances', date: '03/06/2026', day: 'mercredi', type: 'Vacances', isFixed: true }, { month: 'juin', week: 'Vacances', date: '04/06/2026', day: 'jeudi', type: 'Vacances', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '07/06/2026', day: 'dimanche', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '08/06/2026', day: 'lundi', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '09/06/2026', day: 'mardi', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '10/06/2026', day: 'mercredi', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '11/06/2026', day: 'jeudi', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '14/06/2026', day: 'dimanche', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '15/06/2026', day: 'lundi', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '16/06/2026', day: 'mardi', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '17/06/2026', day: 'mercredi', type: 'Examen Final 2', isFixed: true }, { month: 'juin', week: 'Examen Final 2', date: '18/06/2026', day: 'jeudi', type: 'Examen Final 2', isFixed: true } ];
    const oldAcademicCalendar = [ { month: 'Août', week: 1, date: '24/08/2025', day: 'Dimanche', type: 'Orientation' }, { month: 'Août', week: 1, date: '25/08/2025', day: 'Lundi', type: 'Orientation' }, { month: 'Août', week: 1, date: '26/08/2025', day: 'Mardi', type: 'Révision (à remplir)' }, { month: 'Août', week: 1, date: '27/08/2025', day: 'Mercredi', type: 'Révision (à remplir)' }, { month: 'Août', week: 1, date: '28/08/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Août', week: 2, date: '31/08/2025', day: 'Dimanche', type: 'Cours normal' }, { month: 'Septembre', week: 2, date: '01/09/2025', day: 'Lundi', type: 'Cours normal' }, { month: 'Septembre', week: 2, date: '02/09/2025', day: 'Mardi', type: 'Cours normal' }, { month: 'Septembre', week: 2, date: '03/09/2025', day: 'Mercredi', type: 'Cours normal' }, { month: 'Septembre', week: 2, date: '04/09/2025', day: 'Jeudi', type: 'Cours normal' }, { month: 'Septembre', week: 3, date: '07/09/2025', day: 'Dimanche', type: 'Cours normal' }, { month: 'Septembre', week: 3, date: '08/09/2025', day: 'Lundi', type: 'Cours normal' }, { month: 'Septembre', week: 3, date: '09/09/2025', day: 'Mardi', type: 'Cours normal' }, { month: 'Septembre', week: 3, date: '10/09/2025', day: 'Mercredi', type: 'Cours normal' }, { month: 'Septembre', week: 3, date: '11/09/2025', day: 'Jeudi', type: 'Cours normal' }, { month: 'Septembre', week: 4, date: '14/09/2025', day: 'Dimanche', type: 'Cours normal' }, { month: 'Septembre', week: 4, date: '15/09/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Septembre', week: 4, date: '16/09/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Septembre', week: 4, date: '17/09/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Septembre', week: 4, date: '18/09/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Septembre', week: 5, date: '21/09/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Septembre', week: 5, date: '22/09/2025', day: 'Lundi', 'type': 'Congé de la Fête nationale' }, { month: 'Septembre', week: 5, date: '23/09/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Septembre', week: 5, date: '24/09/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Septembre', week: 5, date: '25/09/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Septembre', week: 6, date: '28/09/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Septembre', week: 6, date: '29/09/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Septembre', week: 6, date: '30/09/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Octobre', week: 6, date: '01/10/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Octobre', week: 6, date: '02/10/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Octobre', week: 7, date: '05/10/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Octobre', week: 7, date: '06/10/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Octobre', week: 7, date: '07/10/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Octobre', week: 7, date: '08/10/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Octobre', week: 7, date: '09/10/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Octobre', week: 8, date: '12/10/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Octobre', week: 8, date: '13/10/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Octobre', week: 8, date: '14/10/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Octobre', week: 8, date: '15/10/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Octobre', week: 8, date: '16/10/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Octobre', week: 9, date: '19/10/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Octobre', week: 9, date: '20/10/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Octobre', week: 9, date: '21/10/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Octobre', week: 9, date: '22/10/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Octobre', week: 9, date: '23/10/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Octobre', week: 10, date: '26/10/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Octobre', week: 10, date: '27/10/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Octobre', week: 10, date: '28/10/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Octobre', week: 10, date: '29/10/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Octobre', week: 10, date: '30/10/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Novembre', week: 11, date: '02/11/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Novembre', week: 11, date: '03/11/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Novembre', week: 11, date: '04/11/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Novembre', week: 11, date: '05/11/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Novembre', week: 11, date: '06/11/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Novembre', week: 12, date: '09/11/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Novembre', week: 12, date: '10/11/2025', day: 'Lundi', 'type': 'Vacances d’automne' }, { month: 'Novembre', week: 12, date: '11/11/2025', day: 'Mardi', 'type': 'Vacances d’automne' }, { month: 'Novembre', week: 12, date: '12/11/2025', day: 'Mercredi', 'type': 'Vacances d’automne' }, { month: 'Novembre', week: 12, date: '13/11/2025', day: 'Jeudi', 'type': 'Vacances d’automne' }, { month: 'Novembre', week: 13, date: '16/11/2025', day: 'Dimanche', 'type': 'Vacances d’automne' }, { month: 'Novembre', week: 13, date: '17/11/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Novembre', week: 13, date: '18/11/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Novembre', week: 13, date: '19/11/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Novembre', week: 13, date: '20/11/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Novembre', week: 14, date: '23/11/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Novembre', week: 14, date: '24/11/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Novembre', week: 14, date: '25/11/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Novembre', week: 14, date: '26/11/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Novembre', week: 14, date: '27/11/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Novembre', week: 15, date: '30/11/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Décembre', week: 15, date: '01/12/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Décembre', week: 15, date: '02/12/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Décembre', week: 15, date: '03/12/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Décembre', week: 15, date: '04/12/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Décembre', week: 16, date: '07/12/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Décembre', week: 16, date: '08/12/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Décembre', week: 16, date: '09/12/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Décembre', week: 16, date: '10/12/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Décembre', week: 16, date: '11/12/2025', day: 'Jeudi', 'type': 'Week-end prolongé' }, { month: 'Décembre', week: 17, date: '14/12/2025', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Décembre', week: 17, date: '15/12/2025', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Décembre', week: 17, date: '16/12/2025', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Décembre', week: 17, date: '17/12/2025', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Décembre', week: 17, date: '18/12/2025', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Décembre', week: 18, date: '21/12/2025', day: 'Dimanche', 'type': 'Examens Semestre 1' }, { month: 'Décembre', week: 18, date: '22/12/2025', day: 'Lundi', 'type': 'Examens Semestre 1' }, { month: 'Décembre', week: 18, date: '23/12/2025', day: 'Mardi', 'type': 'Examens Semestre 1' }, { month: 'Décembre', week: 18, date: '24/12/2025', day: 'Mercredi', 'type': 'Vacances d’automne' }, { month: 'Décembre', week: 18, date: '25/12/2025', day: 'Jeudi', 'type': 'Vacances d’automne' }, { month: 'Décembre', week: 19, date: '28/12/2025', day: 'Dimanche', 'type': 'Vacances d’automne' }, { month: 'Décembre', week: 19, date: '29/12/2025', day: 'Lundi', 'type': 'Vacances d’automne' }, { month: 'Décembre', week: 19, date: '30/12/2025', day: 'Mardi', 'type': 'Examens Semestre 1' }, { month: 'Décembre', week: 19, date: '31/12/2025', day: 'Mercredi', 'type': 'Examens Semestre 1' }, { month: 'Janvier', week: 19, date: '01/01/2026', day: 'Jeudi', 'type': 'Examens Semestre 1' }, { month: 'Janvier', week: 20, date: '04/01/2026', day: 'Dimanche', 'type': 'Vacances de mi-année' }, { month: 'Janvier', week: 20, date: '05/01/2026', day: 'Lundi', 'type': 'Vacances de mi-année' }, { month: 'Janvier', week: 20, date: '06/01/2026', day: 'Mardi', 'type': 'Vacances de mi-année' }, { month: 'Janvier', week: 20, date: '07/01/2026', day: 'Mercredi', 'type': 'Vacances de mi-année' }, { month: 'Janvier', week: 20, date: '08/01/2026', day: 'Jeudi', 'type': 'Vacances de mi-année' }, { month: 'Janvier', week: 21, date: '11/01/2026', day: 'Dimanche', 'type': 'Vacances de mi-année' }, { month: 'Janvier', week: 21, date: '12/01/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Janvier', week: 21, date: '13/01/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Janvier', week: 21, date: '14/01/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Janvier', week: 21, date: '15/01/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Janvier', week: 22, date: '18/01/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Janvier', week: 22, date: '19/01/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Janvier', week: 22, date: '20/01/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Janvier', week: 22, date: '21/01/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Janvier', week: 22, date: '22/01/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Janvier', week: 23, date: '25/01/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Janvier', week: 23, date: '26/01/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Janvier', week: 23, date: '27/01/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Janvier', week: 23, date: '28/01/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Janvier', week: 23, date: '29/01/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Février', week: 24, date: '01/02/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Février', week: 24, date: '02/02/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Février', week: 24, date: '03/02/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Février', week: 24, date: '04/02/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Février', week: 24, date: '05/02/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Février', week: 25, date: '08/02/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Février', week: 25, date: '09/02/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Février', week: 25, date: '10/02/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Février', week: 25, date: '11/02/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Février', week: 25, date: '12/02/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Février', week: 26, date: '15/02/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Février', week: 26, date: '16/02/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Février', week: 26, date: '17/02/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Février', week: 26, date: '18/02/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Février', week: 26, date: '19/02/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Février', week: 27, date: '22/02/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Février', week: 27, date: '23/02/2026', day: 'Lundi', 'type': 'Congé de la Journée de la Fondation' }, { month: 'Février', week: 27, date: '24/02/2026', day: 'Mardi', 'type': 'Vacances d’hiver' }, { month: 'Février', week: 27, date: '25/02/2026', day: 'Mercredi', 'type': 'Vacances d’hiver' }, { month: 'Février', week: 27, date: '26/02/2026', day: 'Jeudi', 'type': 'Vacances d’hiver' }, { month: 'Mars', week: 28, date: '01/03/2026', day: 'Dimanche', 'type': 'Vacances d’hiver' }, { month: 'Mars', week: 28, date: '02/03/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Mars', week: 28, date: '03/03/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Mars', week: 28, date: '04/03/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Mars', week: 28, date: '05/03/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Mars', week: 29, date: '08/03/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Mars', week: 29, date: '09/03/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Mars', week: 29, date: '10/03/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Mars', week: 29, date: '11/03/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Mars', week: 29, date: '12/03/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Mars', week: 30, date: '15/03/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Mars', week: 30, date: '16/03/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Mars', week: 30, date: '17/03/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Mars', week: 30, date: '18/03/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Mars', week: 30, date: '19/03/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Mars', week: 31, date: '22/03/2026', day: 'Dimanche', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Mars', week: 31, date: '23/03/2026', day: 'Lundi', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Mars', week: 31, date: '24/03/2026', day: 'Mardi', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Mars', week: 31, date: '25/03/2026', day: 'Mercredi', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Mars', week: 31, date: '26/03/2026', day: 'Jeudi', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Mars', week: 32, date: '29/03/2026', day: 'Dimanche', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Mars', week: 32, date: '30/03/2026', day: 'Lundi', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Mars', week: 32, date: '31/03/2026', day: 'Mardi', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Avril', week: 32, date: '01/04/2026', day: 'Mercredi', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Avril', week: 32, date: '02/04/2026', day: 'Jeudi', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Avril', week: 33, date: '05/04/2026', day: 'Dimanche', 'type': 'Vacances de l’Aïd al-Fitr' }, { month: 'Avril', week: 33, date: '06/04/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Avril', week: 33, date: '07/04/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Avril', week: 33, date: '08/04/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Avril', week: 33, date: '09/04/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Avril', week: 34, date: '12/04/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Avril', week: 34, date: '13/04/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Avril', week: 34, date: '14/04/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Avril', week: 34, date: '15/04/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Avril', week: 34, date: '16/04/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Avril', week: 35, date: '19/04/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Avril', week: 35, date: '20/04/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Avril', week: 35, date: '21/04/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Avril', week: 35, date: '22/04/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Avril', week: 35, date: '23/04/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Avril', week: 36, date: '26/04/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Avril', week: 36, date: '27/04/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Avril', week: 36, date: '28/04/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Avril', week: 36, date: '29/04/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Avril', week: 36, date: '30/04/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Mai', week: 37, date: '03/05/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Mai', week: 37, date: '04/05/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Mai', week: 37, date: '05/05/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Mai', week: 37, date: '06/05/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Mai', week: 37, date: '07/05/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Mai', week: 38, date: '10/05/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Mai', week: 38, date: '11/05/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Mai', week: 38, date: '12/05/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Mai', week: 38, date: '13/05/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Mai', week: 38, date: '14/05/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Mai', week: 39, date: '17/05/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Mai', week: 39, date: '18/05/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Mai', week: 39, date: '19/05/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Mai', week: 39, date: '20/05/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Mai', week: 39, date: '21/05/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Mai', week: 40, date: '24/05/2026', day: 'Dimanche', 'type': 'Cours normal' }, { month: 'Mai', week: 40, date: '25/05/2026', day: 'Lundi', 'type': 'Cours normal' }, { month: 'Mai', week: 40, date: '26/05/2026', day: 'Mardi', 'type': 'Cours normal' }, { month: 'Mai', week: 40, date: '27/05/2026', day: 'Mercredi', 'type': 'Cours normal' }, { month: 'Mai', week: 40, date: '28/05/2026', day: 'Jeudi', 'type': 'Cours normal' }, { month: 'Mai', week: 41, date: '31/05/2026', day: 'Dimanche', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 41, date: '01/06/2026', day: 'Lundi', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 41, date: '02/06/2026', day: 'Mardi', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 41, date: '03/06/2026', day: 'Mercredi', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 41, date: '04/06/2026', day: 'Jeudi', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 42, date: '07/06/2026', day: 'Dimanche', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 42, date: '08/06/2026', day: 'Lundi', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 42, date: '09/06/2026', day: 'Mardi', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 42, date: '10/06/2026', day: 'Mercredi', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 42, date: '11/06/2026', day: 'Jeudi', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 43, date: '14/06/2026', day: 'Dimanche', 'type': 'Vacances de l’Aïd al-Adha' }, { month: 'Juin', week: 43, date: '15/06/2026', day: 'Lundi', 'type': 'Examens Semestre 2' }, { month: 'Juin', week: 43, date: '16/06/2026', day: 'Mardi', 'type': 'Examens Semestre 2' }, { month: 'Juin', week: 43, date: '17/06/2026', day: 'Mercredi', 'type': 'Examens Semestre 2' }, { month: 'Juin', week: 43, date: '18/06/2026', day: 'Jeudi', 'type': 'Examens Semestre 2' }, { month: 'Juin', week: 44, date: '21/06/2026', day: 'Dimanche', 'type': 'Examens Semestre 2' }, { month: 'Juin', week: 44, date: '22/06/2026', day: 'Lundi', 'type': 'Examens Semestre 2' }, { month: 'Juin', week: 44, date: '23/06/2026', day: 'Mardi', 'type': 'Examens Semestre 2' }, { month: 'Juin', week: 44, date: '24/06/2026', day: 'Mercredi', 'type': 'Examens Semestre 2' }, { month: 'Juin', week: 44, date: '25/06/2026', day: 'Jeudi', 'type': 'Fin des cours' }];
    const isPlannable = (event) => event && !event.isFixed && ['Cours Normal', 'Evaluation', 'Révision', 'Orientation'].includes(event.type);

    function generateInitialData(calendar = academicCalendar) {
        const data = [standardHeaders];
        calendar.forEach(event => {
            const weekLabel = typeof event.week === 'number' ? `S${event.week}` : event.week;
            const newRow = Array(standardHeaders.length).fill('');
            newRow[0] = event.month; newRow[1] = weekLabel; newRow[2] = event.date; newRow[3] = event.day; newRow[4] = event.type || 'Cours Normal';
            data.push(newRow);
        });
        return data;
    }

    // --- LE RESTE DU SCRIPT EST IDENTIQUE, MAIS UTILISE MAINTENANT 'apiRequest' ---

    function showClasses(section) { document.querySelectorAll('.section-classes').forEach(div => { div.style.display = 'none'; }); document.getElementById(section).style.display = 'block'; }
    function showInitialSelection() { document.getElementById('classView').style.display = 'none'; document.getElementById('initialSelection').style.display = 'block'; currentClass = null; savedData = {}; document.getElementById('matiereSelect').innerHTML = "<option value=''>Sélectionner une matière</option>"; document.getElementById('output').innerHTML = ""; document.getElementById('filterBy').value = ""; document.getElementById('filterOptions').innerHTML = ""; document.getElementById('filterOptions').style.display = 'none'; document.getElementById('showFilledOnly').checked = false; }
    
    async function goToClass(className) {
        currentClass = className;
        document.getElementById('initialSelection').style.display = 'none';
        document.getElementById('classView').style.display = 'block';
        document.getElementById('classTitle').textContent = `Classe ${className}`;
        savedData = {};
        // ... réinitialisation de l'UI ...
        if (!className) return;
        showProgressBar();
        try {
            const [tableResponse, allSelectionsResponse] = await Promise.all([
                apiRequest('loadLatestCopy', { className }),
                apiRequest('loadAllSelectionsForClass', { className })
            ]);

            if (tableResponse.success && Array.isArray(tableResponse.tables)) {
                tableResponse.tables.forEach(({ matiere, data }) => { savedData[matiere] = data; });
            }
            let allSelections = allSelectionsResponse.success ? allSelectionsResponse.allSelections : {};
            
            // La logique de migration reste, au cas où d'anciennes données existeraient
            const { wasMigrationNeeded, migratedTables } = await migrateDataIfNeeded(className, savedData, allSelections);
            if (wasMigrationNeeded) {
                console.log("Migration terminée. Mise à jour des données locales.");
                savedData = migratedTables;
            }

            populateMatiereSelect(className);
            const subjects = classSubjects[className] || [];
            subjects.forEach(subject => {
                if (!savedData[subject] || savedData[subject].length <= 1) {
                    savedData[subject] = generateInitialData();
                }
            });
            if (subjects.length > 0) {
                document.getElementById('matiereSelect').value = subjects[0];
                displaySelectedTable();
            }
        } catch (error) {
            console.error("Erreur lors du chargement de la classe:", error);
            alert("Erreur de chargement : " + (error.message || 'Erreur inconnue'));
        } finally {
            hideProgressBar();
        }
    }
    
    function populateMatiereSelect(className) {
        const select = document.getElementById('matiereSelect');
        select.innerHTML = "<option value=''>Sélectionner une matière</option>";
        (classSubjects[className] || []).forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            select.appendChild(option);
        });
    }

    async function migrateDataIfNeeded(className, currentTables, allSelections) { /* ... cette fonction reste identique ... */ return { wasMigrationNeeded: false }; } // Simplifié pour la lisibilité, le code complet est plus bas

    function displaySelectedTable() {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (selectedMatiere && currentClass) {
            if (!savedData[selectedMatiere] || savedData[selectedMatiere].length <= 1) {
                savedData[selectedMatiere] = generateInitialData();
            }
            renderTable(selectedMatiere, savedData[selectedMatiere]);
        } else {
            document.getElementById('output').innerHTML = "";
        }
    }
    
    function renderTable(sheetName, jsonData) { 
        const output = document.getElementById('output');
        output.innerHTML = "";
        if (!jsonData || jsonData.length === 0) return;
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const displayedHeaders = ["Mois", "Sem.", "Séan.", "Unité/Chapitre", "Contenu de la leçon", "Ressources (Leçons)", "Devoir", "Ressources (Devoirs)", "Recherche", "Projets"];
        displayedHeaders.forEach(col => { const th = document.createElement('th'); th.textContent = col; headerRow.appendChild(th); });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        let sessionCounters = {};
        const sessionsPerWeek = (classSessionCounts[currentClass] && classSessionCounts[currentClass][sheetName]) || 5;
        
        jsonData.slice(1).forEach((row, dataIndex) => {
            const event = academicCalendar[dataIndex];
            if(!event) return; // Sécurité si les données ne correspondent pas au calendrier

            const weekValue = typeof event.week === 'number' ? `S${event.week}` : event.week;
            if(!sessionCounters[weekValue]) sessionCounters[weekValue] = 0;
            
            const isEventPlannable = isPlannable(event);
            
            if (isEventPlannable) {
                if (sessionCounters[weekValue] >= sessionsPerWeek) { return; }
                sessionCounters[weekValue]++;
            }

            const rowElement = document.createElement('tr');
            const originalRowIndex = savedData[sheetName].findIndex(originalRow => originalRow === row);
            const rowIndexForDB = originalRowIndex !== -1 ? originalRowIndex - 1 : -1;

            const monthTd = document.createElement('td');
            monthTd.textContent = monthAbbreviations[row[0]] || row[0] || '';
            rowElement.appendChild(monthTd);
            
            const weekTd = document.createElement('td');
            weekTd.textContent = row[1] || '';
            rowElement.appendChild(weekTd);

            const seanceTd = document.createElement('td');
            if (isEventPlannable) { seanceTd.textContent = sessionCounters[weekValue]; }
            rowElement.appendChild(seanceTd);
            
            if (event.isFixed) {
                const mergedCell = document.createElement('td');
                mergedCell.colSpan = displayedHeaders.length - 3;
                mergedCell.innerHTML = `<b>${event.type}</b>`;
                mergedCell.classList.add('merged-cell');
                let bgColor = '#f2f2f2';
                if (event.type.includes('Vacances')) bgColor = '#90EE90';
                else if (event.type.includes('Examen')) bgColor = '#FFA07A';
                else if (event.type.includes('day') || event.type.includes('weekend')) bgColor = '#ADD8E6';
                else if (event.type.includes('Fin des cours')) bgColor = '#D3D3D3';
                mergedCell.style.backgroundColor = bgColor;
                rowElement.appendChild(mergedCell);
            } else {
                for (let i = 4; i < standardHeaders.length; i++) {
                    const td = document.createElement('td');
                    const input = document.createElement('textarea');
                    input.value = row[i] || '';
                    input.className = 'modifiable-input';
                    input.dataset.rowIndex = rowIndexForDB;
                    input.dataset.colIndex = i;
                    td.appendChild(input);
                    rowElement.appendChild(td);
                }
            }
            tbody.appendChild(rowElement);
        });
        table.appendChild(tbody);
        output.appendChild(table);
        addEventListenersToTable(sheetName);
        applyFilter();
    }
    
    function addEventListenersToTable(sheetName) {
        document.querySelectorAll('#output .modifiable-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const rowIndex = parseInt(e.target.dataset.rowIndex, 10);
                const colIndex = parseInt(e.target.dataset.colIndex, 10);
                if (rowIndex >= 0 && savedData[sheetName]?.[rowIndex + 1]) {
                    savedData[sheetName][rowIndex + 1][colIndex] = e.target.value;
                }
            });
        });
    }

    async function saveTable(isSilent = false) {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (!currentClass || !selectedMatiere || !savedData[selectedMatiere]) {
            if (!isSilent) alert("Veuillez sélectionner une classe et une matière.");
            return;
        }
        if (!isSilent) showProgressBar();
        const response = await apiRequest('saveTable', { className: currentClass, sheetName: selectedMatiere, data: savedData[selectedMatiere] });
        if (!isSilent) hideProgressBar();
        if (response.error) {
            if (!isSilent) alert("Erreur: " + response.error);
        } else {
            if (!isSilent) alert("Modifications enregistrées !");
        }
    }

    async function deleteMatiereData() {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (!currentClass || !selectedMatiere) {
            alert("Veuillez sélectionner une classe et une matière à supprimer.");
            return;
        }
        if (confirm(`Êtes-vous sûr de vouloir supprimer TOUTES les données pour la matière "${selectedMatiere}" ? Cette action est irréversible.`)) {
            showProgressBar();
            const response = await apiRequest('deleteMatiereData', { className: currentClass, sheetName: selectedMatiere });
            hideProgressBar();
            if (response.success) {
                alert(`Les données pour la matière "${selectedMatiere}" ont été supprimées.`);
                savedData[selectedMatiere] = generateInitialData();
                displaySelectedTable();
            } else {
                alert("Erreur lors de la suppression des données : " + response.error);
            }
        }
    }
    
    async function generatePdf() {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (!currentClass || !selectedMatiere) return alert("Veuillez sélectionner une classe et une matière.");
        showProgressBar();
        try {
            const response = await fetch('https://cdn.glitch.global/f461e390-5b59-4aff-85c7-7f85022f90bc/Syllabus%20Distribution%204.docx?v=1751417043269');
            if (!response.ok) throw new Error("Le modèle Word n'a pas pu être chargé.");
            const template = await response.arrayBuffer();
            const zip = new PizZip(template);
            const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true, nullGetter: () => "" });

            const templateData = prepareWordDataForSubject(selectedMatiere, savedData[selectedMatiere], currentClass);
            doc.render(templateData);

            const docxBuffer = doc.getZip().generate({ type: 'uint8array' });
            
            const apiResponse = await fetch('/api/generatePdfOnServer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ docxBuffer, fileName: `${currentClass}_${selectedMatiere}.docx` })
            });

            if (!apiResponse.ok) {
                const err = await apiResponse.json();
                throw new Error(err.error || 'Erreur serveur PDF');
            }

            const pdfBlob = await apiResponse.blob();
            saveAs(pdfBlob, `${currentClass}_${selectedMatiere}_Distribution.pdf`);

        } catch (error) {
            console.error('Erreur lors de la génération PDF:', error);
            alert('Erreur lors de la génération du PDF: ' + error.message);
        } finally {
            hideProgressBar();
        }
    }
    
    // Le reste des fonctions (UI, filtres, génération de fichiers) reste identique
    function populateFilterOptions(){const filterBy=document.getElementById('filterBy').value;const selectedMatiere=document.getElementById('matiereSelect').value;const filterOptionsSelect=document.getElementById('filterOptions');filterOptionsSelect.innerHTML='';filterOptionsSelect.style.display='none';if(!selectedMatiere||!filterBy||!savedData[selectedMatiere]){return;} const columnIndex={Mois:0,Semaine:1}[filterBy];if(columnIndex===undefined){return;} const options=new Set();const data=savedData[selectedMatiere];if(data&&data.length>1){data.slice(1).forEach(row=>{const cellValue=row[columnIndex]?.toString().trim();if(cellValue){options.add(cellValue);}});} if(options.size>0){filterOptionsSelect.style.display='inline-block';filterOptionsSelect.innerHTML='<option value="">Tous</option>';Array.from(options).sort().forEach(optionValue=>{filterOptionsSelect.innerHTML+=`<option value="${optionValue}">${optionValue}</option>`;});} applyFilter();}
    function applyFilter(){toggleFilledRows();}
    function clearFilter(){document.getElementById('filterBy').value="";document.getElementById('filterOptions').innerHTML = ""; document.getElementById('filterOptions').style.display='none';document.getElementById('showFilledOnly').checked=false;toggleFilledRows();}
    function toggleFilledRows(){const showFilledOnly=document.getElementById('showFilledOnly').checked;const tableBody=document.querySelector('#output table tbody');if(!tableBody)return;const filterBy=document.getElementById('filterBy').value;const filterValue=document.getElementById('filterOptions').value;const columnIndex={Mois:0,Semaine:1}[filterBy];tableBody.querySelectorAll('tr').forEach((rowElement, visualRowIndex)=>{let isVisible=true;if(filterBy&&filterValue){const internalRow = savedData[document.getElementById('matiereSelect').value][visualRowIndex + 1]; if(internalRow){ const cellContent=internalRow[columnIndex]?.toString().trim();if(cellContent!==filterValue)isVisible=false;}} if(showFilledOnly&&isVisible){let isFilled=false;if(rowElement.querySelector('.merged-cell')){isFilled=false;}else{const textInputs=rowElement.querySelectorAll('.modifiable-input');textInputs.forEach(input=>{if(input.value.trim()!=='')isFilled=true;});} if(!isFilled)isVisible=false;} rowElement.style.display=isVisible?'':'none';});}
    function showProgressBar(){const bar=document.getElementById('progressBar');bar.style.display='block';bar.firstElementChild.style.width='10%';}
    function hideProgressBar(){const bar=document.getElementById('progressBar');bar.style.display='none';bar.firstElementChild.style.width='0';}
    function handleFileUpload(event) { if (!currentClass || !document.getElementById('matiereSelect').value) { alert("Veuillez d'abord sélectionner une classe et une matière."); event.target.value = ''; return; } const file = event.target.files[0]; if (file) { showProgressBar(); const reader = new FileReader(); reader.onload = async (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const importedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); fillTableWithExcelData(importedData); } catch (error) { console.error("Erreur lors de l'importation du fichier:", error); alert("Une erreur s'est produite lors de la lecture du fichier Excel."); } finally { hideProgressBar(); event.target.value = ''; } }; reader.readAsArrayBuffer(file); } }
    function fillTableWithExcelData(importedData) { const selectedMatiere = document.getElementById('matiereSelect').value; if (!currentClass || !selectedMatiere) { alert("Veuillez d'abord sélectionner une classe et une matière."); return; } const headerOffset = importedData[0]?.[0]?.toLowerCase().includes('unité') || importedData[0]?.[1]?.toLowerCase().includes('contenu') ? 1 : 0; const dataToImport = importedData.slice(headerOffset); const sessionsPerWeek = (classSessionCounts[currentClass] && classSessionCounts[currentClass][selectedMatiere]) || 0; const availableSlots = []; let sessionCounters = {}; savedData[selectedMatiere].slice(1).forEach((appRow, appRowIndex) => { const event = academicCalendar[appRowIndex]; const weekValue = typeof event.week === 'number' ? `S${event.week}` : event.week; if(!sessionCounters[weekValue]) sessionCounters[weekValue] = 0; if (isPlannable(event)) { if (sessionCounters[weekValue] < sessionsPerWeek) { availableSlots.push(appRow); } sessionCounters[weekValue]++; } }); dataToImport.forEach((importedRow, importIndex) => { if (importIndex < availableSlots.length) { const targetRow = availableSlots[importIndex]; targetRow[4] = importedRow[0] || ''; targetRow[5] = importedRow[1] || ''; targetRow[6] = importedRow[2] || ''; targetRow[7] = importedRow[3] || ''; targetRow[8] = importedRow[4] || ''; targetRow[9] = importedRow[5] || ''; targetRow[10] = importedRow[6] || ''; } }); renderTable(selectedMatiere, savedData[selectedMatiere]); saveTable(true); alert('Importation terminée ! Les données ont été insérées uniquement dans les séances prévues pour cette matière.'); }
    function generateExcel() { const selectedMatiere = document.getElementById('matiereSelect').value; if (!currentClass || !selectedMatiere) { alert("Veuillez sélectionner une classe et une matière."); return; } const dataForExport = prepareExcelDataForSubject(selectedMatiere); if (!dataForExport) { alert("Pas de données à exporter."); return; } const worksheet = XLSX.utils.aoa_to_sheet(dataForExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, selectedMatiere); const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' }); saveAs(new Blob([excelBuffer], { type: 'application/octet-stream' }), `${currentClass}_${selectedMatiere}_Distribution.xlsx`); }
    async function generateExcelZipForClass() { if (!currentClass) { alert("Veuillez d'abord sélectionner une classe."); return; } if (Object.keys(savedData).length === 0) { alert("Les données de la classe ne sont pas encore chargées. Veuillez patienter ou recharger."); return; } showProgressBar(); try { const zip = new JSZip(); const subjects = classSubjects[currentClass]; if (!subjects || subjects.length === 0) { throw new Error("Aucune matière n'est définie pour cette classe."); } for (const subject of subjects) { const dataForExport = prepareExcelDataForSubject(subject); if (dataForExport) { const worksheet = XLSX.utils.aoa_to_sheet(dataForExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, subject); const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' }); zip.file(`${currentClass}_${subject}_Distribution.xlsx`, excelBuffer); } } if (Object.keys(zip.files).length > 0) { const content = await zip.generateAsync({ type: "blob" }); saveAs(content, `Distribution_Excel_${currentClass}.zip`); } else { alert("Aucun document Excel n'a pu être généré. Vérifiez que les matières contiennent des données."); } } catch (error) { console.error('Erreur lors de la génération du ZIP de fichiers Excel:', error); alert('Une erreur est survenue : ' + error.message); } finally { hideProgressBar(); } }
    function prepareExcelDataForSubject(subjectName) { const sheetData = savedData[subjectName]; if (!sheetData || sheetData.length <=1) { return null; } const exportHeaders = ["Mois", "Semaine", "Séance", "Unité/Chapitre", "Contenu de la leçon", "Ressources pour les leçons", "Devoir", "Ressources pour les devoirs", "Recherche", "Projets"]; const dataForExport = [exportHeaders]; let sessionCounters = {}; const sessionsPerWeek = (classSessionCounts[currentClass] && classSessionCounts[currentClass][subjectName]) || 0; sheetData.slice(1).forEach((row, dataIndex) => { const event = academicCalendar[dataIndex]; const weekValue = typeof event.week === 'number' ? `S${event.week}` : event.week; if (!sessionCounters[weekValue]) sessionCounters[weekValue] = 0; let seanceValue = ''; if (isPlannable(event)) { if(sessionCounters[weekValue] < sessionsPerWeek) { sessionCounters[weekValue]++; seanceValue = sessionCounters[weekValue]; } else { return; } } if (!isPlannable(event)) { dataForExport.push([ monthAbbreviations[row[0]] || row[0] || '', row[1] || '', '', event.type, '', '', '', '', '', '' ]); } else { dataForExport.push([ monthAbbreviations[row[0]] || row[0] || '', row[1] || '', seanceValue, row[4] || '', row[5] || '', row[6] || '', row[7] || '', row[8] || '', row[9] || '', row[10] || '' ]); } }); return dataForExport; }
    function prepareWordDataForSubject(subjectName, subjectData, className) { const data = subjectData.slice(1); const dataForWord = data.filter((row, i) => academicCalendar[i] && academicCalendar[i].month !== 'août'); const dataByMonth = {}; dataForWord.forEach((row, index) => { const originalIndex = data.findIndex(d => d === row); const event = academicCalendar[originalIndex]; if (!event) return; const month = event.month; const week = typeof event.week === 'number' ? `S${event.week}` : event.week; if (!dataByMonth[month]) { dataByMonth[month] = { month_name: month.charAt(0).toUpperCase() + month.slice(1), weeks: {} }; } if (!dataByMonth[month].weeks[week]) { dataByMonth[month].weeks[week] = { week_name: week, seances: [] }; } }); let sessionCounters = {}; const sessionsPerWeek = (classSessionCounts[className] && classSessionCounts[className][subjectName]) || 0; dataForWord.forEach((row, index) => { const originalIndex = data.findIndex(d => d === row); const event = academicCalendar[originalIndex]; if (!event) return; const month = event.month; const week = typeof event.week === 'number' ? `S${event.week}` : event.week; if (!sessionCounters[week]) sessionCounters[week] = 0; if (isPlannable(event)) { if (sessionCounters[week] < sessionsPerWeek) { sessionCounters[week]++; const seanceData = { chapitre: row[4] || '', contenu_lecon: row[5] || '', res_lecon: row[6] || '', devoir: row[7] || '', res_devoir: row[8] || '', recherche: row[9] || '', projet: row[10] || '' }; const isFilled = Object.values(seanceData).some(val => val && val.trim() !== ''); if (isFilled) { seanceData.seance_num = sessionCounters[week]; dataByMonth[month].weeks[week].seances.push(seanceData); } } } else if (event.isFixed) { const weekSeances = dataByMonth[month].weeks[week].seances; if (!weekSeances.some(s => s.chapitre === event.type)) { const specialSeance = { seance_num: ' ', chapitre: event.type, contenu_lecon: '', res_lecon: '', devoir: '', res_devoir: '', recherche: '', projet: '' }; dataByMonth[month].weeks[week].seances.push(specialSeance); } } }); const monthsForTemplate = Object.values(dataByMonth).map((monthData, monthIndex) => { const monthRow = { month_name: monthData.month_name, page_break: monthIndex > 0 ? '<w:p><w:r><w:br w:type="page"/></w:r></w:p>' : '' }; const weeksInMonth = Object.values(monthData.weeks); for(let i=0; i<5; i++) { const weekProp = `week${i+1}`; if(weeksInMonth[i] && weeksInMonth[i].seances.length > 0) { monthRow[`${weekProp}_name`] = weeksInMonth[i].week_name; monthRow[`${weekProp}_seances`] = weeksInMonth[i].seances.sort((a, b) => { if (a.seance_num === ' ') return -1; if (b.seance_num === ' ') return 1; return a.seance_num - b.seance_num; }); } else { monthRow[`${weekProp}_name`] = ''; monthRow[`${weekProp}_seances`] = []; } } return monthRow; }); return { class_name: className, subject_name: subjectName, months: monthsForTemplate.filter(m => m.week1_seances.length > 0 || m.week2_seances.length > 0 || m.week3_seances.length > 0 || m.week4_seances.length > 0 || m.week5_seances.length > 0) }; }
    async function generateWord() { const selectedMatiere = document.getElementById('matiereSelect').value; if (!currentClass || !selectedMatiere) { alert("Veuillez sélectionner une classe et une matière."); return; } showProgressBar(); try { const response = await fetch('https://cdn.glitch.global/f461e390-5b59-4aff-85c7-7f85022f90bc/Syllabus%20Distribution%204.docx?v=1751417043269'); if (!response.ok) throw new Error("Le modèle Word n'a pas pu être chargé."); const template = await response.arrayBuffer(); const zip = new PizZip(template); const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true, nullGetter: () => "" }); const templateData = prepareWordDataForSubject(selectedMatiere, savedData[selectedMatiere], currentClass); doc.render(templateData); const out = doc.getZip().generate({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' }); saveAs(out, `${currentClass}_${selectedMatiere}_Distribution.docx`); } catch (error) { console.error('Erreur lors de la génération du Word:', error); alert('Erreur lors de la génération du document Word. Vérifiez la console pour plus de détails.'); } finally { hideProgressBar(); } }
    async function generateWordZipForClass() { if (!currentClass) { alert("Veuillez d'abord sélectionner une classe."); return; } if (Object.keys(savedData).length === 0) { alert("Les données de la classe ne sont pas encore chargées. Veuillez patienter ou recharger."); return; } showProgressBar(); try { const zip = new JSZip(); const subjects = classSubjects[currentClass]; if (!subjects || subjects.length === 0) { throw new Error("Aucune matière n'est définie pour cette classe."); } const response = await fetch('https://cdn.glitch.global/f461e390-5b59-4aff-85c7-7f85022f90bc/Syllabus%20Distribution%204.docx?v=1751417043269'); if (!response.ok) throw new Error("Le modèle Word n'a pas pu être chargé."); const template = await response.arrayBuffer(); for (const subject of subjects) { const subjectData = savedData[subject]; if (!subjectData || subjectData.length <= 1) { continue; } const templateData = prepareWordDataForSubject(subject, subjectData, currentClass); if (templateData.months.length > 0) { const pizZip = new PizZip(template.slice(0)); const doc = new docxtemplater(pizZip, { paragraphLoop: true, linebreaks: true, nullGetter: () => "" }); doc.render(templateData); const out = doc.getZip().generate({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' }); zip.file(`${currentClass}_${subject}_Distribution.docx`, out); } } if (Object.keys(zip.files).length > 0) { const content = await zip.generateAsync({ type: "blob" }); saveAs(content, `Distribution_Word_${currentClass}.zip`); } else { alert("Aucun document n'a pu être généré. Vérifiez que les matières contiennent des données."); } } catch (error) { console.error('Erreur lors de la génération du ZIP de documents Word:', error); alert('Une erreur est survenue : ' + error.message); } finally { hideProgressBar(); } }
    
    showInitialSelection();
</script>
</body>
</html>
