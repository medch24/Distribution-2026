<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Distribution Annuelle 2025-2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.6/dist/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- La ligne pour socket.io.js a √©t√© supprim√©e d'ici -->
    <style>
        body { font-family: Arial, sans-serif; background-color: #f5f5f5; color: #333; text-align: center; padding: 20px; }
        h1 { color: #2a5d9f; font-size: 32px; margin-bottom: 30px; }
        button { font-size: 18px; margin: 10px 5px; padding: 10px 20px; border: none; background-color: #4CAF50; color: white; cursor: pointer; border-radius: 5px; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        .section-classes { display: none; margin-top: 20px; }
        .section-classes button { margin: 5px; padding: 8px 15px; font-size: 16px; }
        #initialSelection {}
        #classView { display: none; margin-top: 30px; text-align: left; }
        #classView h1 { text-align: center; font-size: 24px; }
        label, select, input[type="checkbox"] { font-size: 16px; margin: 10px 5px; display: inline-block; vertical-align: middle; }
        select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; vertical-align: middle; }
        button { vertical-align: middle; }
        .table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; min-width: 1200px; border-collapse: collapse; margin: 20px 0; background-color: #ffffff; table-layout: fixed; }
        th, td { padding: 8px; text-align: left; border: 1px solid #ddd; font-size: 12px; word-wrap: break-word; vertical-align: top; }
        th { background-color: #2a5d9f; color: white; font-weight: bold; position: sticky; top: 0; z-index: 1; }
        .merged-cell { font-weight: bold; text-align: center; vertical-align: middle; color: #333; }
        .modifiable-input { width: calc(100% - 16px); min-height: 80px; padding: 8px; border-radius: 5px; resize: vertical; font-size: 12px; box-sizing: border-box; display: block; margin: 0; border: 1px solid #ccc; }
        th:nth-child(1), td:nth-child(1) { width: 45px; } th:nth-child(2), td:nth-child(2) { width: 45px; } th:nth-child(3), td:nth-child(3) { width: 45px; text-align: center; }
        #progressBar { width: 100%; height: 20px; background-color: #f3f3f3; border: 1px solid #ddd; display: none; position: relative; margin: 20px 0; }
        #progressBar div { height: 100%; width: 0; background-color: #4CAF50; transition: width 0.4s ease-in-out; }
    </style>
</head>
<body>
<div id="initialSelection">
    <h1>Distribution Annuelle 2025-2026</h1>
    <button onclick="showClasses('maternelle')">Section Maternelle</button>
    <button onclick="showClasses('primaire')">Section Primaire</button>
    <button onclick="showClasses('secondaire')">Section Secondaire (PEI et P. Dipl√¥me)</button>
    <div id="maternelle" class="section-classes">
        <button onclick="goToClass('TPS')">TPS</button><button onclick="goToClass('PS')">PS</button><button onclick="goToClass('MS')">MS</button><button onclick="goToClass('GS')">GS</button>
    </div>
    <div id="primaire" class="section-classes">
        <button onclick="goToClass('PP1')">PP1</button><button onclick="goToClass('PP2')">PP2</button><button onclick="goToClass('PP3')">PP3</button><button onclick="goToClass('PP4')">PP4</button><button onclick="goToClass('PP5')">PP5</button>
    </div>
    <div id="secondaire" class="section-classes">
        <button onclick="goToClass('PEI1')">PEI1</button><button onclick="goToClass('PEI2')">PEI2</button><button onclick="goToClass('PEI3')">PEI3</button><button onclick="goToClass('PEI4')">PEI4</button><button onclick="goToClass('PEI5')">PEI5</button><button onclick="goToClass('DP1')">DP1</button><button onclick="goToClass('DP2')">DP2</button>
    </div>
</div>
<div id="classView" style="display: none;">
    <h1 id="classTitle"></h1>
    <button onclick="showInitialSelection()" style="background-color: #6c757d;">Changer de Classe</button>
    <div class="button-container" style="margin-bottom: 20px; margin-top: 10px;">
        <button onclick="generateExcel()">G√©n√©rer Excel (Mati√®re)</button>
        <button onclick="generateWord()">G√©n√©rer Word (Mati√®re)</button>
        <button onclick="generatePdf()" style="background-color: #c82333;">G√©n√©rer PDF (Mati√®re)</button>
        <button onclick="generateExcelZipForClass()">G√©n√©rer Excel (ZIP par Classe)</button>
        <button onclick="generateWordZipForClass()">G√©n√©rer Word (ZIP par Classe)</button>
        <button onclick="saveTable()">Enregistrer les modifications</button>
        <button onclick="document.getElementById('excelUploadInput').click()" style="background-color: #17a2b8;">Importer Excel</button>
        <input type="file" id="excelUploadInput" style="display: none;" onchange="handleFileUpload(event)" accept=".xlsx, .xls">
        <button onclick="runSystemDiagnostic()" style="background-color: #28a745;">ü©∫ Diagnostic Syst√®me</button>
    </div>
    <div>
        <label for="matiereSelect">Choisir une mati√®re :</label>
        <select id="matiereSelect" onchange="displaySelectedTable()"><option value="">S√©lectionner une mati√®re</option></select>
    </div>
    <div style="margin-top: 20px;">
        <label for="filterBy">Filtrer par :</label>
        <select id="filterBy" onchange="populateFilterOptions()">
            <option value="">S√©lectionner un filtre</option>
            <option value="Mois">Mois</option>
            <option value="Semaine">Semaine</option>
        </select>
        <select id="filterOptions" onchange="applyFilter()" style="display: none;"></select>
        <button onclick="clearFilter()" style="background-color: #ffc107;">Annuler le filtre</button>
        <label style="margin-left: 20px;"><input type="checkbox" id="showFilledOnly" onclick="toggleFilledRows()"> Afficher uniquement les lignes remplies</label>
    </div>
    <div id="progressBar"><div></div></div>
    <div class="table-container">
        <div id="output"></div>
    </div>
</div>

<script>
    let currentClass = null; let savedData = {};
    const standardHeaders = ["Mois", "Semaine", "Date", "Jour", "Unit√©/Chapitre", "Contenu de la le√ßon", "Ressources pour les le√ßons", "Devoir", "Ressources pour les devoirs", "Recherche", "Projets"];
    const monthAbbreviations = { 'Janvier': 'Janv.', 'F√©vrier': 'F√©vr.', 'Mars': 'Mars', 'Avril': 'Avr.', 'Mai': 'Mai', 'Juin': 'Juin', 'Juillet': 'Juil.', 'Ao√ªt': 'Ao√ªt', 'Septembre': 'Sept.', 'Octobre': 'Oct.', 'Novembre': 'Nov.', 'D√©cembre': 'D√©c.' }; 
    const classSubjects = { 'TPS': ['Fran√ßais', 'Maths', 'Sciences', 'ART', '√âducation physique', 'Montessori', 'Musique', 'Biblioth√®que'],'PS': ['Fran√ßais', 'Maths', 'Sciences', 'ART', '√âducation physique', 'Montessori', 'Musique', 'Biblioth√®que'],'MS': ['Fran√ßais', 'Maths', 'Sciences', 'Informatique', 'ART', '√âducation physique', 'Montessori', 'Musique', 'Biblioth√®que'],'GS': ['Fran√ßais', 'Maths', 'Sciences', 'Informatique', 'ART', '√âducation physique', 'Montessori', 'Musique', 'Biblioth√®que'],'PP1': ['Fran√ßais', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences Naturelles', 'Sciences Humaines', 'ART', '√âducation physique', 'Montessori', 'Musique', 'Biblioth√®que'], 'PP2': ['Fran√ßais', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences Naturelles', 'Sciences Humaines', 'ART', '√âducation physique', 'Montessori', 'Musique', 'Biblioth√®que'],'PP3': ['Fran√ßais', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences Naturelles', 'Sciences Humaines', 'ART', '√âducation physique', 'Montessori', 'Musique', 'Biblioth√®que'], 'PP4': ['Fran√ßais', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences humaines', 'Sciences naturelles', 'ART', '√âducation physique', 'Musique', 'Biblioth√®que'], 'PP5': ['Fran√ßais', 'Maths', 'Anglais', 'French second language', 'Informatique', 'Sciences Naturelles', 'Sciences Humaines', 'ART', '√âducation physique', 'Musique', 'Biblioth√®que'], 'PEI1': ['Langue et litt√©rature', 'Maths', 'Sciences', 'Anglais', 'French second language', 'Design', 'Individus et Soci√©t√©s', 'ART', '√âducation physique', 'Musique', 'Biblioth√®que'], 'PEI2': ['Maths', 'Langue et litt√©rature', 'Anglais', 'French second language', 'Biologie', 'Design', 'Individus et Soci√©t√©s', 'Physique-chimie', 'ART', '√âducation physique', 'Musique', 'Biblioth√®que'], 'PEI3': ['Maths', 'Langue et litt√©rature', 'Anglais', 'French second language', 'Biologie', 'Design', 'Individus et Soci√©t√©s', 'Physique-chimie', 'ART', '√âducation physique', 'Musique', 'Biblioth√®que'], 'PEI4': ['Maths', 'Biologie', 'Langue et litt√©rature', 'Anglais', 'Design', 'Individus et Soci√©t√©s', 'Physique-chimie', 'ART', '√âducation physique', 'Musique', 'Biblioth√®que'],'PEI5': ['Maths', 'Biologie', 'Individus et Soci√©t√©s', 'Langue et litt√©rature', 'Physique-chimie', 'Anglais', 'Sciences √âconomiques et Sociales', 'Sciences numeriques et Technologies', 'ART', '√âducation physique', 'Musique', 'Biblioth√®que'],'DP1': ['Biologie', 'Maths', 'Individus et Soci√©t√©s', 'Anglais', 'Langue et litt√©rature', 'Physique-chimie', 'Sciences √âconomiques', '√âducation physique', 'ART', 'Biblioth√®que', 'Enseignement Scientifique'],'DP2': ['Langue et litt√©rature', 'Maths', 'Biologie', 'Individus et Soci√©t√©s', 'Physique-chimie', 'Anglais', 'Histoire', '√âducation physique', 'ART', 'Biblioth√®que', 'Enseignement Scientifique'] }; 
    const classSessionCounts = {"MS": {"Fran√ßais": 8, "Maths": 5, "Sciences": 4, "√âducation physique": 2, "Montessori": 2, "Musique": 1, "ART": 1, "Biblioth√®que": 1}, "GS": {"Fran√ßais": 10, "Maths": 5, "Sciences": 5, "√âducation physique": 2, "Informatique": 2, "Montessori": 2, "Musique": 1, "ART": 1, "Biblioth√®que": 1}, "PP1": {"Fran√ßais": 8, "Maths": 5, "Anglais": 3, "Sciences Humaines": 3, "Sciences Naturelles": 3, "√âducation physique": 2, "Montessori": 1, "ART": 1, "Informatique": 1, "Musique": 1, "Biblioth√®que": 1}, "PP2": {"Fran√ßais": 8, "Maths": 5, "Anglais": 3, "Sciences Humaines": 3, "Sciences Naturelles": 3, "√âducation physique": 2, "Montessori": 1, "ART": 1, "Informatique": 1, "Musique": 1, "Biblioth√®que": 1}, "PP3": {"Fran√ßais": 8, "Maths": 5, "Anglais": 3, "Sciences Humaines": 3, "Sciences Naturelles": 3, "√âducation physique": 2, "Montessori": 1, "ART": 1, "Informatique": 1, "Musique": 1, "Biblioth√®que": 1}, "PP4": {"Fran√ßais": 9, "Maths": 5, "Anglais": 3, "Sciences Naturelles": 3, "Sciences Humaines": 3, "√âducation physique": 2, "Informatique": 1, "Musique": 1, "ART": 1, "Biblioth√®que": 1}, "PP5": {"Fran√ßais": 9, "Maths": 5, "Anglais": 3, "Sciences Naturelles": 3, "Sciences Humaines": 3, "√âducation physique": 2, "Informatique": 1, "Musique": 1, "ART": 1, "Biblioth√®que": 1}, "PEI1": {"Langue et litt√©rature": 6, "Maths": 5, "Sciences": 5, "Individus et Soci√©t√©s": 3, "Anglais": 3, "Design": 2, "√âducation physique": 2, "Musique": 1, "ART": 1, "Biblioth√®que": 1}, "PEI2": {"Langue et litt√©rature": 5, "Maths": 5, "Individus et Soci√©t√©s": 3, "Biologie": 3, "Design": 3, "Physique-chimie": 3, "Anglais": 3, "√âducation physique": 1, "Musique": 1, "ART": 1, "Biblioth√®que": 1}, "PEI3": {"Langue et litt√©rature": 5, "Maths": 5, "Individus et Soci√©t√©s": 3, "Biologie": 3, "Design": 3, "Physique-chimie": 3, "Anglais": 3, "√âducation physique": 1, "Musique": 1, "ART": 1, "Biblioth√®que": 1}, "PEI4": {"Langue et litt√©rature": 5, "Maths": 5, "Biologie": 4, "Physique-chimie": 4, "Design": 3, "Individus et Soci√©t√©s": 3, "Anglais": 3, "√âducation physique": 1, "ART": 1, "Biblioth√®que": 1}, "PEI5": {"Maths": 6, "Langue et litt√©rature": 5, "Individus et Soci√©t√©s": 4, "Physique-chimie": 4, "Biologie": 4, "Anglais": 3, "S.E.S": 2, "S.N.T": 1, "√âducation physique": 1, "ART": 1, "Biblioth√®que": 1}, "DP1": {"Maths": 6, "Langue et litt√©rature": 4, "Individus et Soci√©t√©s": 4, "Biologie": 4, "Physique-chimie": 4, "Anglais": 3, "Enseignement Scientifique": 3, "S.E.S": 1, "√âducation physique": 1, "ART": 1, "Biblioth√®que": 1}, "DP2": {"Maths": 6, "Langue et litt√©rature": 4, "Biologie": 4, "Individus et Soci√©t√©s": 4, "Physique-chimie": 4, "Enseignement Scientifique": 3, "Anglais": 3, "S.E.S": 1, "History": 1, "√âducation physique": 1, "ART": 1, "Biblioth√®que": 1}}; 
    const academicCalendar = [ { month: 'Ao√ªt', week: 'Semaine 1', date: '31/08/2025', day: 'Dimanche', type: 'Orientation' }, { month: 'Septembre', week: 'Semaine 1', date: '01/09/2025', day: 'Lundi', type: 'Orientation' }, { month: 'Septembre', week: 'Semaine 1', date: '02/09/2025', day: 'Mardi', type: 'Orientation' }, { month: 'Septembre', week: 'Semaine 1', date: '03/09/2025', day: 'Mercredi', type: 'Orientation' }, { month: 'Septembre', week: 'Semaine 1', date: '04/09/2025', day: 'Jeudi', type: 'Orientation' }, { month: 'Septembre', week: 'Semaine 2', date: '07/09/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 2', date: '08/09/2025', day: 'Lundi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 2', date: '09/09/2025', day: 'Mardi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 2', date: '10/09/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 2', date: '11/09/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 3', date: '14/09/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 3', date: '15/09/2025', day: 'Lundi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 3', date: '16/09/2025', day: 'Mardi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 3', date: '17/09/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 3', date: '18/09/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 4', date: '21/09/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 4', date: '22/09/2025', day: 'Lundi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 4', date: '23/09/2025', day: 'Mardi', type: 'Saudi National day' }, { month: 'Septembre', week: 'Semaine 4', date: '24/09/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 4', date: '25/09/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 5', date: '28/09/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 5', date: '29/09/2025', day: 'Lundi', type: 'Cours' }, { month: 'Septembre', week: 'Semaine 5', date: '30/09/2025', day: 'Mardi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 5', date: '01/10/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 5', date: '02/10/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 6', date: '05/10/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 6', date: '06/10/2025', day: 'Lundi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 6', date: '07/10/2025', day: 'Mardi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 6', date: '08/10/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 6', date: '09/10/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 7', date: '12/10/2025', day: 'Dimanche', type: 'evaluation' }, { month: 'Octobre', week: 'Semaine 7', date: '13/10/2025', day: 'Lundi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 7', date: '14/10/2025', day: 'Mardi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 7', date: '15/10/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 7', date: '16/10/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 8', date: '19/10/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 8', date: '20/10/2025', day: 'Lundi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 8', date: '21/10/2025', day: 'Mardi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 8', date: '22/10/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 8', date: '23/10/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 9', date: '26/10/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 9', date: '27/10/2025', day: 'Lundi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 9', date: '28/10/2025', day: 'Mardi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 9', date: '29/10/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Octobre', week: 'Semaine 9', date: '30/10/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 10', date: '02/11/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 10', date: '03/11/2025', day: 'Lundi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 10', date: '04/11/2025', day: 'Mardi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 10', date: '05/11/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 10', date: '06/11/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 11', date: '09/11/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 11', date: '10/11/2025', day: 'Lundi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 11', date: '11/11/2025', day: 'Mardi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 11', date: '12/11/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 11', date: '13/11/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 12', date: '16/11/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 12', date: '17/11/2025', day: 'Lundi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 12', date: '18/11/2025', day: 'Mardi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 12', date: '19/11/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 12', date: '20/11/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 13', date: '23/11/2025', day: 'Dimanche', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 13', date: '24/11/2025', day: 'Lundi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 13', date: '25/11/2025', day: 'Mardi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 13', date: '26/11/2025', day: 'Mercredi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 13', date: '27/11/2025', day: 'Jeudi', type: 'Cours' }, { month: 'Novembre', week: 'Semaine 14', date: '30/11/2025', day: 'Dimanche', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 14', date: '01/12/2025', day: 'Lundi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 14', date: '02/12/2025', day: 'Mardi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 14', date: '03/12/2025', day: 'Mercredi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 14', date: '04/12/2025', day: 'Jeudi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 15', date: '07/12/2025', day: 'Dimanche', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 15', date: '08/12/2025', day: 'Lundi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 15', date: '09/12/2025', day: 'Mardi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 15', date: '10/12/2025', day: 'Mercredi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 15', date: '11/12/2025', day: 'Jeudi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 16', date: '14/12/2025', day: 'Dimanche', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 16', date: '15/12/2025', day: 'Lundi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 16', date: '16/12/2025', day: 'Mardi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 16', date: '17/12/2025', day: 'Mercredi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 16', date: '18/12/2025', day: 'Jeudi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 17', date: '21/12/2025', day: 'Dimanche', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 17', date: '22/12/2025', day: 'Lundi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 17', date: '23/12/2025', day: 'Mardi', type: 'Cours' }, { month: 'D√©cembre', week: 'Semaine 17', date: '24/12/2025', day: 'Mercredi', type: 'examen' }, { month: 'D√©cembre', week: 'Semaine 17', date: '25/12/2025', day: 'Jeudi', type: 'examen' }, { month: 'D√©cembre', week: 'examen', date: '28/12/2025', day: 'Dimanche', type: 'examen' }, { month: 'D√©cembre', week: 'examen', date: '29/12/2025', day: 'Lundi', type: 'examen' }, { month: 'D√©cembre', week: 'examen', date: '30/12/2025', day: 'Mardi', type: 'examen' }, { month: 'D√©cembre', week: 'examen', date: '31/12/2025', day: 'Mercredi', type: 'examen' }, { month: 'Janvier', week: 'examen', date: '01/01/2026', day: 'Jeudi', type: 'examen' }, { month: 'Janvier', week: 'examen', date: '04/01/2026', day: 'Dimanche', type: 'examen' }, { month: 'Janvier', week: 'examen', date: '05/01/2026', day: 'Lundi', type: 'examen' }, { month: 'Janvier', week: 'examen', date: '06/01/2026', day: 'Mardi', type: 'examen' }, { month: 'Janvier', week: 'examen', date: '07/01/2026', day: 'Mercredi', type: 'examen' }, { month: 'Janvier', week: 'examen', date: '08/01/2026', day: 'Jeudi', type: 'examen' }, { month: 'Janvier', week: 'Vacance', date: '11/01/2026', day: 'Dimanche', type: 'Vacance' }, { month: 'Janvier', week: 'Vacance', date: '12/01/2026', day: 'Lundi', type: 'Vacance' }, { month: 'Janvier', week: 'Vacance', date: '13/01/2026', day: 'Mardi', type: 'Vacance' }, { month: 'Janvier', week: 'Vacance', date: '14/01/2026', day: 'Mercredi', type: 'Vacance' }, { month: 'Janvier', week: 'Vacance', date: '15/01/2026', day: 'Jeudi', type: 'Vacance' }, { month: 'Janvier', week: 'Semaine 18', date: '18/01/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 18', date: '19/01/2026', day: 'Lundi', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 18', date: '20/01/2026', day: 'Mardi', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 18', date: '21/01/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 18', date: '22/01/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 19', date: '25/01/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 19', date: '26/01/2026', day: 'Lundi', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 19', date: '27/01/2026', day: 'Mardi', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 19', date: '28/01/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Janvier', week: 'Semaine 19', date: '29/01/2026', day: 'Jeudi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 20', date: '01/02/2026', day: 'Dimanche', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 20', date: '02/02/2026', day: 'Lundi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 20', date: '03/02/2026', day: 'Mardi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 20', date: '04/02/2026', day: 'Mercredi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 20', date: '05/02/2026', day: 'Jeudi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 21', date: '08/02/2026', day: 'Dimanche', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 21', date: '09/02/2026', day: 'Lundi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 21', date: '10/02/2026', day: 'Mardi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 21', date: '11/02/2026', day: 'Mercredi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 21', date: '12/02/2026', day: 'Jeudi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 22', date: '15/02/2026', day: 'Dimanche', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 22', date: '16/02/2026', day: 'Lundi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 22', date: '17/02/2026', day: 'Mardi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 22', date: '18/02/2026', day: 'Mercredi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 22', date: '19/02/2026', day: 'Jeudi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 23', date: '22/02/2026', day: 'Dimanche', type: 'Saudi Fondation Day' }, { month: 'F√©vrier', week: 'Semaine 23', date: '23/02/2026', day: 'Lundi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 23', date: '24/02/2026', day: 'Mardi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 23', date: '25/02/2026', day: 'Mercredi', type: 'Cours' }, { month: 'F√©vrier', week: 'Semaine 23', date: '26/02/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Mars', week: 'Semaine 24', date: '01/03/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Mars', week: 'Semaine 24', date: '02/03/2026', day: 'Lundi', type: 'Cours' }, { month: 'Mars', week: 'Semaine 24', date: '03/03/2026', day: 'Mardi', type: 'Cours' }, { month: 'Mars', week: 'Semaine 24', date: '04/03/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Mars', week: 'Semaine 24', date: '05/03/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Mars', week: 'Vacance', date: '08/03/2026', day: 'Dimanche', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '09/03/2026', day: 'Lundi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '10/03/2026', day: 'Mardi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '11/03/2026', day: 'Mercredi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '12/03/2026', day: 'Jeudi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '15/03/2026', day: 'Dimanche', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '16/03/2026', day: 'Lundi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '17/03/2026', day: 'Mardi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '18/03/2026', day: 'Mercredi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '19/03/2026', day: 'Jeudi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '22/03/2026', day: 'Dimanche', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '23/03/2026', day: 'Lundi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '24/03/2026', day: 'Mardi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '25/03/2026', day: 'Mercredi', type: 'Vacance' }, { month: 'Mars', week: 'Vacance', date: '26/03/2026', day: 'Jeudi', type: 'Vacance' }, { month: 'Mars', week: 'Semaine 25', date: '29/03/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Mars', week: 'Semaine 25', date: '30/03/2026', day: 'Lundi', type: 'Cours' }, { month: 'Mars', week: 'Semaine 25', date: '31/03/2026', day: 'Mardi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 25', date: '01/04/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 25', date: '02/04/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 26', date: '05/04/2026', day: 'Dimanche', type: 'evaluation' }, { month: 'Avril', week: 'Semaine 26', date: '06/04/2026', day: 'Lundi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 26', date: '07/04/2026', day: 'Mardi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 26', date: '08/04/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 26', date: '09/04/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 27', date: '12/04/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Avril', week: 'Semaine 27', date: '13/04/2026', day: 'Lundi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 27', date: '14/04/2026', day: 'Mardi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 27', date: '15/04/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 27', date: '16/04/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 28', date: '19/04/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Avril', week: 'Semaine 28', date: '20/04/2026', day: 'Lundi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 28', date: '21/04/2026', day: 'Mardi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 28', date: '22/04/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 28', date: '23/04/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 29', date: '26/04/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Avril', week: 'Semaine 29', date: '27/04/2026', day: 'Lundi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 29', date: '28/04/2026', day: 'Mardi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 29', date: '29/04/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Avril', week: 'Semaine 29', date: '30/04/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Mai', week: 'Semaine 30', date: '03/05/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Mai', week: 'Semaine 30', date: '04/05/2026', day: 'Lundi', type: 'Cours' }, { month: 'Mai', week: 'Semaine 30', date: '05/05/2026', day: 'Mardi', type: 'Cours' }, { month: 'Mai', week: 'Semaine 30', date: '06/05/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Mai', week: 'Semaine 30', date: '07/05/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Mai', week: 'Semaine 31', date: '10/05/2026', day: 'Dimanche', type: 'Cours' }, { month: 'Mai', week: 'Semaine 31', date: '11/05/2026', day: 'Lundi', type: 'Cours' }, { month: 'Mai', week: 'Semaine 31', date: '12/05/2026', day: 'Mardi', type: 'Cours' }, { month: 'Mai', week: 'Semaine 31', date: '13/05/2026', day: 'Mercredi', type: 'Cours' }, { month: 'Mai', week: 'Semaine 31', date: '14/05/2026', day: 'Jeudi', type: 'Cours' }, { month: 'Mai', week: 'Vacance', date: '17/05/2026', day: 'Dimanche', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '18/05/2026', day: 'Lundi', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '19/05/2026', day: 'Mardi', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '20/05/2026', day: 'Mercredi', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '21/05/2026', day: 'Jeudi', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '24/05/2026', day: 'Dimanche', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '25/05/2026', day: 'Lundi', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '26/05/2026', day: 'Mardi', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '27/05/2026', day: 'Mercredi', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '28/05/2026', day: 'Jeudi', type: 'Vacance' }, { month: 'Mai', week: 'Vacance', date: '31/05/2026', day: 'Dimanche', type: 'Vacance' }, { month: 'Juin', week: 'Vacance', date: '01/06/2026', day: 'Lundi', type: 'Vacance' }, { month: 'Juin', week: 'examen', date: '02/06/2026', day: 'Mardi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '03/06/2026', day: 'Mercredi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '04/06/2026', day: 'Jeudi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '07/06/2026', day: 'Dimanche', type: 'examen' }, { month: 'Juin', week: 'examen', date: '08/06/2026', day: 'Lundi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '09/06/2026', day: 'Mardi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '10/06/2026', day: 'Mercredi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '11/06/2026', day: 'Jeudi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '14/06/2026', day: 'Dimanche', type: 'examen' }, { month: 'Juin', week: 'examen', date: '15/06/2026', day: 'Lundi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '16/06/2026', day: 'Mardi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '17/06/2026', day: 'Mercredi', type: 'examen' }, { month: 'Juin', week: 'examen', date: '18/06/2026', day: 'Jeudi', type: 'examen' } ];

    const isPlannable = (event) => event && event.type === 'Cours';

    const isSpecialDay = (event) => {
        if (!event) return false;
        const type = event.type.toLowerCase();
        return type.includes('day') || 
               type.includes('examen') || 
               type.includes('f√™te') || 
               type.includes('f√©ri√©') || 
               type.includes('cong√©') ||
               type.includes('weekend') ||
               type.includes('evaluation');
    };



    // === GESTION AM√âLIOR√âE DES ERREURS ===
    
    function showErrorMessage(message, duration = 5000) {
        // Cr√©er un √©l√©ment d'erreur s'il n'existe pas
        let errorDiv = document.getElementById('errorMessage');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'errorMessage';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #f8d7da;
                color: #721c24;
                padding: 15px;
                border: 1px solid #f5c6cb;
                border-radius: 5px;
                max-width: 400px;
                z-index: 1000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                font-size: 14px;
            `;
            document.body.appendChild(errorDiv);
        }
        
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        // Auto-hide apr√®s duration ms
        setTimeout(() => {
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }, duration);
    }
    
    function showSuccessMessage(message, duration = 3000) {
        // Cr√©er un √©l√©ment de succ√®s s'il n'existe pas
        let successDiv = document.getElementById('successMessage');
        if (!successDiv) {
            successDiv = document.createElement('div');
            successDiv.id = 'successMessage';
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #d4edda;
                color: #155724;
                padding: 15px;
                border: 1px solid #c3e6cb;
                border-radius: 5px;
                max-width: 400px;
                z-index: 1000;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                font-size: 14px;
            `;
            document.body.appendChild(successDiv);
        }
        
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        
        // Auto-hide apr√®s duration ms
        setTimeout(() => {
            if (successDiv) {
                successDiv.style.display = 'none';
            }
        }, duration);
    }

    async function apiCall(endpoint, payload) {
        try {
            const response = await fetch(`/api/${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                let errorMessage = `Erreur du serveur: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (parseError) {
                    console.warn('Impossible de parser la r√©ponse d\'erreur JSON:', parseError);
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(errorMessage);
            }
            
            if (endpoint === 'generatePdfOnServer') {
                return response.blob();
            }

            return response.json();
        } catch (error) {
            console.error(`Erreur API pour ${endpoint}:`, error);
            
            // Afficher un message d'erreur am√©lior√© selon le type d'erreur
            if (error instanceof TypeError && error.message.includes('fetch')) {
                showErrorMessage('Erreur de connexion. V√©rifiez votre connexion internet et que le serveur fonctionne.');
            } else if (error.message.includes('404')) {
                showErrorMessage('Service non trouv√©. V√©rifiez la configuration du serveur.');
            } else if (error.message.includes('500')) {
                showErrorMessage('Erreur interne du serveur. V√©rifiez les variables d\'environnement (MongoDB, ConvertAPI).');
            } else {
                showErrorMessage(`Erreur: ${error.message}`);
            }
            
            throw error;
        }
    }

    async function goToClass(className) {
        currentClass = className;
        document.getElementById('initialSelection').style.display = 'none';
        document.getElementById('classView').style.display = 'block';
        document.getElementById('classTitle').textContent = `Classe ${className}`;
        savedData = {};
        document.getElementById('matiereSelect').innerHTML = "<option value=''>S√©lectionner une mati√®re</option>";
        document.getElementById('output').innerHTML = "";
        document.getElementById('filterBy').value = "";
        document.getElementById('filterOptions').style.display = 'none';
        document.getElementById('showFilledOnly').checked = false;
        if (!className) return;
        
        showProgressBar();
        try {
            const [tableResponse, allSelectionsResponse] = await Promise.all([
                apiCall('loadLatestCopy', { className }),
                apiCall('loadAllSelectionsForClass', { className })
            ]);

            if (tableResponse.success && Array.isArray(tableResponse.tables)) {
                tableResponse.tables.forEach(({ matiere, data }) => { savedData[matiere] = data; });
            }
            
            populateMatiereSelect(className);
            const subjects = classSubjects[className] || [];
            subjects.forEach(subject => {
                if (!savedData[subject] || savedData[subject].length <= 1) {
                    savedData[subject] = generateInitialData();
                }
            });
            if (subjects.length > 0) {
                document.getElementById('matiereSelect').value = subjects[0];
                displaySelectedTable();
            }
        } catch (error) {
            console.error("Erreur lors du chargement de la classe:", error);
            showErrorMessage("Erreur de chargement de la classe: " + error.message);
        } finally {
            hideProgressBar();
        }
    }
    
    async function saveTable(isSilent = false) {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (!currentClass || !selectedMatiere || !savedData[selectedMatiere]) {
            if (!isSilent) alert("Veuillez s√©lectionner une classe et une mati√®re.");
            return;
        }
        if (savedData[selectedMatiere].length <= 1) {
            if (!isSilent) alert("Aucune donn√©e √† enregistrer.");
            return;
        }
        if (!isSilent) showProgressBar();
        try {
            const ack = await apiCall('saveTable', { className: currentClass, sheetName: selectedMatiere, data: savedData[selectedMatiere] });
            if (ack.success) {
                if (!isSilent) showSuccessMessage("Modifications enregistr√©es avec succ√®s!");
            }
        } catch (error) {
            if (!isSilent) showErrorMessage("Erreur lors de l'enregistrement: " + error.message);
        } finally {
            if (!isSilent) hideProgressBar();
        }
    }

    async function deleteMatiereData() {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (!currentClass || !selectedMatiere) {
            alert("Veuillez s√©lectionner une classe et une mati√®re √† supprimer.");
            return;
        }
        if (confirm(`√ätes-vous s√ªr de vouloir supprimer TOUTES les donn√©es pour la mati√®re "${selectedMatiere}" dans la classe ${currentClass} ?\nCette action est irr√©versible.`)) {
            showProgressBar();
            try {
                const ack = await apiCall('deleteMatiereData', { className: currentClass, sheetName: selectedMatiere });
                if (ack.success) {
                    alert(`Les donn√©es pour la mati√®re "${selectedMatiere}" ont √©t√© supprim√©es.`);
                    savedData[selectedMatiere] = generateInitialData();
                    displaySelectedTable();
                }
            } catch (error) {
                alert("Erreur lors de la suppression des donn√©es : " + error.message);
            } finally {
                hideProgressBar();
            }
        }
    }
    
    async function generatePdf() {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (!currentClass || !selectedMatiere) {
            alert("Veuillez s√©lectionner une classe et une mati√®re.");
            return;
        }
        showProgressBar();
        try {
            const response = await fetch('https://docs.google.com/document/d/1FLux_zEr90hvMRRODtex0c7d5tHTtFS1/export?format=docx');
            if (!response.ok) throw new Error("Le mod√®le Word n'a pas pu √™tre charg√©.");
            const template = await response.arrayBuffer();
            const zip = new PizZip(template);
            const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true, nullGetter: () => "" });

            const templateData = prepareWordDataForSubject(selectedMatiere, savedData[selectedMatiere], currentClass);
            doc.render(templateData);

            const docxBuffer = doc.getZip().generate({ type: 'uint8array' });
            
            const base64String = btoa(String.fromCharCode.apply(null, docxBuffer));

            const pdfBlob = await apiCall('generatePdfOnServer', {
                docxBuffer: base64String,
                fileName: `${currentClass}_${selectedMatiere}_Distribution.docx`
            });

            saveAs(pdfBlob, `${currentClass}_${selectedMatiere}_Distribution.pdf`);

        } catch (error) {
            console.error('Erreur lors de la g√©n√©ration du PDF:', error);
            alert('Une erreur est survenue lors de la g√©n√©ration du PDF: ' + error.message);
        } finally {
            hideProgressBar();
        }
    }

    async function generateWord() {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (!currentClass || !selectedMatiere) {
            alert("Veuillez s√©lectionner une classe et une mati√®re.");
            return;
        }
        showProgressBar();
        try {
            const response = await fetch('https://docs.google.com/document/d/1uFWwBSy4RuF6d5zpy_2nOa43Q4ITm3Bs/export?format=docx');
            if (!response.ok) throw new Error("Le mod√®le Word n'a pas pu √™tre charg√©.");
            const template = await response.arrayBuffer();
            const zip = new PizZip(template);
            const doc = new docxtemplater(zip, { paragraphLoop: true, linebreaks: true, nullGetter: () => "" });

            const templateData = prepareWordDataForSubject(selectedMatiere, savedData[selectedMatiere], currentClass);
            doc.render(templateData);

            const docxBlob = doc.getZip().generate({ 
                type: 'blob',
                mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            });

            saveAs(docxBlob, `${currentClass}_${selectedMatiere}_Distribution.docx`);
            showSuccessMessage("Document Word g√©n√©r√© avec succ√®s!");

        } catch (error) {
            console.error('Erreur lors de la g√©n√©ration du document Word:', error);
            showErrorMessage('Une erreur est survenue lors de la g√©n√©ration du document Word: ' + error.message);
        } finally {
            hideProgressBar();
        }
    }

    async function generateWordZipForClass() {
        if (!currentClass) {
            alert("Veuillez d'abord s√©lectionner une classe.");
            return;
        }
        if (Object.keys(savedData).length === 0) {
            alert("Les donn√©es de la classe ne sont pas encore charg√©es. Veuillez patienter ou recharger.");
            return;
        }
        showProgressBar();
        try {
            const response = await fetch('https://docs.google.com/document/d/1uFWwBSy4RuF6d5zpy_2nOa43Q4ITm3Bs/export?format=docx');
            if (!response.ok) throw new Error("Le mod√®le Word n'a pas pu √™tre charg√©.");
            const template = await response.arrayBuffer();

            const zip = new JSZip();
            const subjects = classSubjects[currentClass];
            
            if (!subjects || subjects.length === 0) {
                throw new Error("Aucune mati√®re n'est d√©finie pour cette classe.");
            }

            for (const subject of subjects) {
                if (savedData[subject] && savedData[subject].length > 1) {
                    try {
                        const templateZip = new PizZip(template);
                        const doc = new docxtemplater(templateZip, { 
                            paragraphLoop: true, 
                            linebreaks: true, 
                            nullGetter: () => "" 
                        });

                        const templateData = prepareWordDataForSubject(subject, savedData[subject], currentClass);
                        doc.render(templateData);

                        const docxBuffer = doc.getZip().generate({ type: 'uint8array' });
                        zip.file(`${currentClass}_${subject}_Distribution.docx`, docxBuffer);
                    } catch (docError) {
                        console.warn(`Erreur lors de la g√©n√©ration du document pour ${subject}:`, docError);
                    }
                }
            }

            if (Object.keys(zip.files).length > 0) {
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `Distribution_Word_${currentClass}.zip`);
                showSuccessMessage("Archive ZIP des documents Word g√©n√©r√©e avec succ√®s!");
            } else {
                alert("Aucun document Word n'a pu √™tre g√©n√©r√©. V√©rifiez que les mati√®res contiennent des donn√©es.");
            }

        } catch (error) {
            console.error('Erreur lors de la g√©n√©ration du ZIP de fichiers Word:', error);
            showErrorMessage('Une erreur est survenue : ' + error.message);
        } finally {
            hideProgressBar();
        }
    }

    function generateInitialData(calendar = academicCalendar) {
        const data = [standardHeaders];
        calendar.forEach(event => {
            const weekLabel = event.week;
            const newRow = Array(standardHeaders.length).fill('');
            newRow[0] = event.month; newRow[1] = weekLabel; newRow[2] = event.date; newRow[3] = event.day; newRow[4] = event.type || 'Cours Normal';
            data.push(newRow);
        });
        return data;
    }
    
    function showClasses(section) { document.querySelectorAll('.section-classes').forEach(div => { div.style.display = 'none'; }); document.getElementById(section).style.display = 'block'; }
    function showInitialSelection() { document.getElementById('classView').style.display = 'none'; document.getElementById('initialSelection').style.display = 'block'; currentClass = null; savedData = {}; document.getElementById('matiereSelect').innerHTML = "<option value=''>S√©lectionner une mati√®re</option>"; document.getElementById('output').innerHTML = ""; document.getElementById('filterBy').value = ""; document.getElementById('filterOptions').innerHTML = ""; document.getElementById('filterOptions').style.display = 'none'; document.getElementById('showFilledOnly').checked = false; }
    
    function populateMatiereSelect(className) {
        const select = document.getElementById('matiereSelect');
        select.innerHTML = "<option value=''>S√©lectionner une mati√®re</option>";
        const subjects = classSubjects[className];
        if (subjects) {
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                select.appendChild(option);
            });
        }
    }

    function displaySelectedTable() {
        const selectedMatiere = document.getElementById('matiereSelect').value;
        if (selectedMatiere && currentClass) {
            if (!savedData[selectedMatiere] || savedData[selectedMatiere].length <= 1) {
                savedData[selectedMatiere] = generateInitialData();
            }
            renderTable(selectedMatiere, savedData[selectedMatiere]);
        } else {
            document.getElementById('output').innerHTML = "";
        }
    }

    function renderTable(sheetName, jsonData) { 
        const output = document.getElementById('output');
        output.innerHTML = "";
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const displayedHeaders = ["Mois", "Sem.", "S√©an.", "Unit√©/Chapitre", "Contenu de la le√ßon", "Ressources (Le√ßons)", "Devoir", "Ressources (Devoirs)", "Recherche", "Projets"];
        displayedHeaders.forEach(col => { const th = document.createElement('th'); th.textContent = col; headerRow.appendChild(th); });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        let sessionCounters = {};
        let weekMaxSessions = {};
        const baseSessionsPerWeek = (classSessionCounts[currentClass] && classSessionCounts[currentClass][sheetName]) || 5;
        
        jsonData.slice(1).forEach((row, dataIndex) => {
            const event = academicCalendar[dataIndex];
            if (!event) return;
            const weekValue = event.week;
            
            if(!weekMaxSessions[weekValue]) {
                // Compter les jours sp√©ciaux qui NE SONT PAS plannables (Saudi National day, evaluation, examen, Saudi Fondation Day)
                // Ces jours R√âDUISENT le nombre de s√©ances normales disponibles
                const specialDaysCount = jsonData.slice(1).filter((r, i) => {
                    const e = academicCalendar[i];
                    return e && e.week === weekValue && !isPlannable(e) && isSpecialDay(e);
                }).length;
                
                // Les jours sp√©ciaux R√âDUISENT le nombre de s√©ances normales
                // Exemple: 6 s√©ances/semaine - 1 jour sp√©cial = 5 s√©ances normales
                weekMaxSessions[weekValue] = Math.max(1, baseSessionsPerWeek - specialDaysCount);
            }
            
            if(!sessionCounters[weekValue]) sessionCounters[weekValue] = 0;
            
            const isSpecialEvent = !isPlannable(event);
            const sessionsPerWeek = weekMaxSessions[weekValue];

            const renderSession = (sessionNum) => {
                const rowElement = document.createElement('tr');
                const originalRowIndex = savedData[sheetName].findIndex(originalRow => originalRow === row);
                const rowIndexForDB = originalRowIndex !== -1 ? originalRowIndex - 1 : -1;
                
                const monthTd = document.createElement('td');
                monthTd.textContent = monthAbbreviations[row[0]] || row[0] || '';
                rowElement.appendChild(monthTd);

                const weekTd = document.createElement('td');
                // Afficher seulement le num√©ro de semaine pour les cours normaux, rien pour les √©v√©nements sp√©ciaux
                if (isSpecialEvent) {
                    weekTd.textContent = '';
                } else {
                    weekTd.textContent = row[1] ? row[1].replace('Semaine ', 'S') : '';
                }
                rowElement.appendChild(weekTd);

                const seanceTd = document.createElement('td');
                if (!isSpecialEvent) { seanceTd.textContent = sessionNum; }
                rowElement.appendChild(seanceTd);
                
                if (isSpecialEvent) {
                    const mergedCell = document.createElement('td');
                    mergedCell.colSpan = displayedHeaders.length - 3;
                    mergedCell.innerHTML = `<b>${event.type}</b>`;
                    mergedCell.classList.add('merged-cell');
                    let bgColor = '#f2f2f2';
                    const typeLC = event.type.toLowerCase();
                    if (typeLC.includes('vacance')) bgColor = '#90EE90';
                    else if (typeLC.includes('examen')) bgColor = '#FFA07A';
                    else if (typeLC.includes('evaluation') || typeLC.includes('√©valuation')) bgColor = '#FFB6C1';
                    else if (typeLC.includes('day')) bgColor = '#ADD8E6';
                    else if (typeLC.includes('orientation')) bgColor = '#FFD700';
                    else if (typeLC.includes('weekend')) bgColor = '#D3D3D3';
                    mergedCell.style.backgroundColor = bgColor;
                    rowElement.appendChild(mergedCell);
                } else {
                    for (let i = 4; i < standardHeaders.length; i++) {
                        const td = document.createElement('td');
                        const input = document.createElement('textarea');
                        input.value = row[i] || '';
                        input.className = 'modifiable-input';
                        input.dataset.rowIndex = rowIndexForDB;
                        input.dataset.colIndex = i;
                        td.appendChild(input);
                        rowElement.appendChild(td);
                    }
                }
                tbody.appendChild(rowElement);
            };

            if (isSpecialEvent) {
                renderSession(null);
            } else {
                const remainingSessions = sessionsPerWeek - sessionCounters[weekValue];
                if (remainingSessions > 0) {
                    const remainingDays = jsonData.slice(dataIndex).filter((r, i) => {
                        const e = academicCalendar[dataIndex + i];
                        return e && e.week === weekValue && isPlannable(e);
                    }).length;
                    
                    if (remainingDays > 0) {
                        const sessionsThisDay = Math.ceil(remainingSessions / remainingDays);
                        const actualSessions = Math.min(sessionsThisDay, remainingSessions);
                        
                        for (let s = 0; s < actualSessions; s++) {
                            sessionCounters[weekValue]++;
                            renderSession(sessionCounters[weekValue]);
                        }
                    }
                }
            }
        });
        
        table.appendChild(tbody);
        output.appendChild(table);
        addEventListenersToTable(sheetName);
        applyFilter();
    }

    function addEventListenersToTable(sheetName) {
        document.querySelectorAll('#output .modifiable-input').forEach(input => {
            input.addEventListener('input', (e) => {
                const rowIndex = parseInt(e.target.dataset.rowIndex);
                const colIndex = parseInt(e.target.dataset.colIndex);
                if (rowIndex >= 0 && savedData[sheetName]?.[rowIndex + 1]) {
                    savedData[sheetName][rowIndex + 1][colIndex] = e.target.value;
                }
            });
        });
    }

    function populateFilterOptions() {
        const filterBy = document.getElementById('filterBy').value;
        const selectedMatiere = document.getElementById('matiereSelect').value;
        const filterOptionsSelect = document.getElementById('filterOptions');
        filterOptionsSelect.innerHTML = '';
        filterOptionsSelect.style.display = 'none';
        if (!selectedMatiere || !filterBy || !savedData[selectedMatiere]) {
            return;
        }
        const columnIndex = {Mois: 0, Semaine: 1}[filterBy];
        if (columnIndex === undefined) {
            return;
        }
        const options = new Set();
        const data = savedData[selectedMatiere];
        if (data && data.length > 1) {
            data.slice(1).forEach((row, i) => {
                const event = academicCalendar[i];
                if (event) {
                    const cellValue = (filterBy === 'Mois' ? event.month : event.week);
                    if (cellValue) {
                        options.add(cellValue);
                    }
                }
            });
        }
        if (options.size > 0) {
            filterOptionsSelect.style.display = 'inline-block';
            filterOptionsSelect.innerHTML = '<option value="">Tous</option>';
            Array.from(options).sort((a, b) => {
                // Tri naturel pour les semaines
                if (filterBy === 'Semaine') {
                    const aNum = parseInt(a.replace('Semaine ', ''));
                    const bNum = parseInt(b.replace('Semaine ', ''));
                    return aNum - bNum;
                }
                return a.localeCompare(b);
            }).forEach(optionValue => {
                filterOptionsSelect.innerHTML += `<option value="${optionValue}">${optionValue}</option>`;
            });
        }
        applyFilter();
    }
    
    function applyFilter() {
        toggleFilledRows();
    }
    
    function clearFilter() {
        document.getElementById('filterBy').value = "";
        document.getElementById('filterOptions').innerHTML = "";
        document.getElementById('filterOptions').style.display = 'none';
        document.getElementById('showFilledOnly').checked = false;
        toggleFilledRows();
    }
    
    function toggleFilledRows() {
        const showFilledOnly = document.getElementById('showFilledOnly').checked;
        const tableBody = document.querySelector('#output table tbody');
        if (!tableBody) return;
        const filterBy = document.getElementById('filterBy').value;
        const filterValue = document.getElementById('filterOptions').value;
        
        tableBody.querySelectorAll('tr').forEach((rowElement) => {
            let isVisible = true;
            
            // Obtenir les valeurs de mois et semaine directement des cellules de la table
            const monthCell = rowElement.querySelector('td:nth-child(1)');
            const weekCell = rowElement.querySelector('td:nth-child(2)');
            
            if (filterBy && filterValue && monthCell && weekCell) {
                const monthValue = monthCell.textContent.trim();
                const weekValue = weekCell.textContent.trim();
                
                if (filterBy === 'Mois') {
                    // Convertir l'abr√©viation en nom complet pour la comparaison
                    const fullMonth = Object.keys(monthAbbreviations).find(key => 
                        monthAbbreviations[key] === monthValue
                    );
                    if (fullMonth !== filterValue && monthValue !== filterValue) {
                        isVisible = false;
                    }
                } else if (filterBy === 'Semaine') {
                    // Reconvertir "S1" en "Semaine 1" pour la comparaison
                    const fullWeek = weekValue.startsWith('S') ? 
                        'Semaine ' + weekValue.substring(1) : weekValue;
                    if (fullWeek !== filterValue && weekValue !== filterValue) {
                        isVisible = false;
                    }
                }
            }
            
            if (showFilledOnly && isVisible) {
                let isFilled = false;
                if (rowElement.querySelector('.merged-cell')) {
                    isFilled = false;
                } else {
                    const textInputs = rowElement.querySelectorAll('.modifiable-input');
                    textInputs.forEach(input => {
                        if (input.value.trim() !== '') isFilled = true;
                    });
                }
                if (!isFilled) isVisible = false;
            }
            
            rowElement.style.display = isVisible ? '' : 'none';
        });
    }
    function showProgressBar(){const bar=document.getElementById('progressBar');bar.style.display='block';bar.firstElementChild.style.width='10%';}
    function hideProgressBar(){const bar=document.getElementById('progressBar');bar.style.display='none';bar.firstElementChild.style.width='0';}
    function handleFileUpload(event) { if (!currentClass || !document.getElementById('matiereSelect').value) { alert("Veuillez d'abord s√©lectionner une classe et une mati√®re."); event.target.value = ''; return; } const file = event.target.files[0]; if (file) { showProgressBar(); const reader = new FileReader(); reader.onload = async (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const importedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); fillTableWithExcelData(importedData); } catch (error) { console.error("Erreur lors de l'importation du fichier:", error); alert("Une erreur s'est produite lors de la lecture du fichier Excel."); } finally { hideProgressBar(); event.target.value = ''; } }; reader.readAsArrayBuffer(file); } }
    function fillTableWithExcelData(importedData) { const selectedMatiere = document.getElementById('matiereSelect').value; if (!currentClass || !selectedMatiere) { alert("Veuillez d'abord s√©lectionner une classe et une mati√®re."); return; } const headerOffset = importedData[0]?.[0]?.toLowerCase().includes('unit√©') || importedData[0]?.[1]?.toLowerCase().includes('contenu') ? 1 : 0; const dataToImport = importedData.slice(headerOffset); const sessionsPerWeek = (classSessionCounts[currentClass] && classSessionCounts[currentClass][selectedMatiere]) || 0; const availableSlots = []; let sessionCounters = {}; savedData[selectedMatiere].slice(1).forEach((appRow, appRowIndex) => { const event = academicCalendar[appRowIndex]; const weekValue = event.week; if(!sessionCounters[weekValue]) sessionCounters[weekValue] = 0; if (isPlannable(event)) { if (sessionCounters[weekValue] < sessionsPerWeek) { availableSlots.push(appRow); } sessionCounters[weekValue]++; } }); dataToImport.forEach((importedRow, importIndex) => { if (importIndex < availableSlots.length) { const targetRow = availableSlots[importIndex]; for(let i = 0; i < 7; i++) { targetRow[i + 4] = importedRow[i] || ''; } } }); renderTable(selectedMatiere, savedData[selectedMatiere]); saveTable(true); alert('Importation termin√©e ! Les donn√©es ont √©t√© ins√©r√©es uniquement dans les s√©ances pr√©vues pour cette mati√®re.'); }
    function generateExcel() { const selectedMatiere = document.getElementById('matiereSelect').value; if (!currentClass || !selectedMatiere) { alert("Veuillez s√©lectionner une classe et une mati√®re."); return; } const dataForExport = prepareExcelDataForSubject(selectedMatiere); if (!dataForExport) { alert("Pas de donn√©es √† exporter."); return; } const worksheet = XLSX.utils.aoa_to_sheet(dataForExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, selectedMatiere); const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' }); saveAs(new Blob([excelBuffer], { type: 'application/octet-stream' }), `${currentClass}_${selectedMatiere}_Distribution.xlsx`); }
    async function generateExcelZipForClass() { if (!currentClass) { alert("Veuillez d'abord s√©lectionner une classe."); return; } if (Object.keys(savedData).length === 0) { alert("Les donn√©es de la classe ne sont pas encore charg√©es. Veuillez patienter ou recharger."); return; } showProgressBar(); try { const zip = new JSZip(); const subjects = classSubjects[currentClass]; if (!subjects || subjects.length === 0) { throw new Error("Aucune mati√®re n'est d√©finie pour cette classe."); } for (const subject of subjects) { const dataForExport = prepareExcelDataForSubject(subject); if (dataForExport) { const worksheet = XLSX.utils.aoa_to_sheet(dataForExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, subject); const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' }); zip.file(`${currentClass}_${subject}_Distribution.xlsx`, excelBuffer); } } if (Object.keys(zip.files).length > 0) { const content = await zip.generateAsync({ type: "blob" }); saveAs(content, `Distribution_Excel_${currentClass}.zip`); } else { alert("Aucun document Excel n'a pu √™tre g√©n√©r√©. V√©rifiez que les mati√®res contiennent des donn√©es."); } } catch (error) { console.error('Erreur lors de la g√©n√©ration du ZIP de fichiers Excel:', error); alert('Une erreur est survenue : ' + error.message); } finally { hideProgressBar(); } }
    function prepareExcelDataForSubject(subjectName) {
        const sheetData = savedData[subjectName];
        if (!sheetData || sheetData.length <= 1) {
            return null;
        }
        
        const exportHeaders = ["Mois", "Semaine", "S√©ance", "Unit√©/Chapitre", "Contenu de la le√ßon", "Ressources pour les le√ßons", "Devoir", "Ressources pour les devoirs", "Recherche", "Projets"];
        const dataForExport = [exportHeaders];
        let sessionCounters = {};
        let weekMaxSessions = {};
        const baseSessionsPerWeek = (classSessionCounts[currentClass] && classSessionCounts[currentClass][subjectName]) || 5;
        
        sheetData.slice(1).forEach((row, dataIndex) => {
            const event = academicCalendar[dataIndex];
            if (!event) return;
            const weekValue = event.week;
            
            if (!weekMaxSessions[weekValue]) {
                const specialDays = sheetData.slice(1).filter((r, i) => {
                    const e = academicCalendar[i];
                    return e && e.week === weekValue && !isPlannable(e) && isSpecialDay(e);
                }).length;
                
                weekMaxSessions[weekValue] = Math.max(1, baseSessionsPerWeek - specialDays);
            }
            
            if (!sessionCounters[weekValue]) sessionCounters[weekValue] = 0;
            
            const sessionsPerWeek = weekMaxSessions[weekValue];
            let seanceValue = '';
            
            if (isPlannable(event)) {
                if (sessionCounters[weekValue] < sessionsPerWeek) {
                    sessionCounters[weekValue]++;
                    seanceValue = sessionCounters[weekValue];
                } else {
                    return;
                }
            }
            
            if (!isPlannable(event)) {
                dataForExport.push([
                    monthAbbreviations[row[0]] || row[0] || '',
                    '', // Pas de num√©ro de semaine pour les √©v√©nements sp√©ciaux
                    '',
                    event.type,
                    '', '', '', '', '', ''
                ]);
            } else {
                dataForExport.push([
                    monthAbbreviations[row[0]] || row[0] || '',
                    row[1] ? row[1].replace('Semaine ', 'S') : '',
                    seanceValue,
                    row[4] || '',
                    row[5] || '',
                    row[6] || '',
                    row[7] || '',
                    row[8] || '',
                    row[9] || '',
                    row[10] || ''
                ]);
            }
        });
        
        return dataForExport;
    }
    function prepareWordDataForSubject(subjectName, subjectData, className) {
        const data = subjectData.slice(1);
        // Filter both data and calendar together, excluding Ao√ªt
        const dataForWord = data.filter((row, i) => academicCalendar[i] && academicCalendar[i].month !== 'Ao√ªt');
        const calendarForWord = academicCalendar.filter(event => event && event.month !== 'Ao√ªt');
        
        // Structure les donn√©es par semaine (utilise le num√©ro de semaine du calendrier)
        const dataByWeek = {};
        
        // Fonction pour extraire le num√©ro de semaine (ex: "Semaine 2" -> 2)
        function getWeekNumber(weekString) {
            const match = weekString.match(/Semaine (\d+)/);
            return match ? parseInt(match[1], 10) : null;
        }
        
        // Initialiser toutes les semaines pr√©sentes dans le calendrier
        dataForWord.forEach((row, index) => {
            const event = calendarForWord[index];
            if (!event) return;
            const week = event.week;
            const weekNum = getWeekNumber(week);
            
            if (weekNum && !dataByWeek[weekNum]) {
                dataByWeek[weekNum] = { 
                    week_name: week, 
                    seances: [] 
                };
            }
        });
        
        let sessionCounters = {};
        let weekMaxSessions = {};
        const baseSessionsPerWeek = (classSessionCounts[className] && classSessionCounts[className][subjectName]) || 5;
        
        dataForWord.forEach((row, index) => {
            const event = calendarForWord[index];
            if (!event) return;
            const week = event.week;
            const weekNum = getWeekNumber(week);
            
            if (!weekNum) return;
            
            if (!weekMaxSessions[weekNum]) {
                const specialDays = calendarForWord.filter((e) => {
                    return e && e.week === week && !isPlannable(e) && isSpecialDay(e);
                }).length;
                
                weekMaxSessions[weekNum] = Math.max(1, baseSessionsPerWeek - specialDays);
            }
            
            if (!sessionCounters[weekNum]) sessionCounters[weekNum] = 0;
            
            const isSpecialEvent = !isPlannable(event);
            const sessionsPerWeek = weekMaxSessions[weekNum];
            
            if (!isSpecialEvent) {
                // Calculer combien de s√©ances restent √† distribuer dans cette semaine
                const remainingSessions = sessionsPerWeek - sessionCounters[weekNum];
                if (remainingSessions > 0) {
                    // Calculer combien de jours planifiables restent dans cette semaine
                    const remainingDays = calendarForWord.slice(index).filter((e) => {
                        return e && e.week === week && isPlannable(e);
                    }).length;
                    
                    if (remainingDays > 0) {
                        // Calculer combien de s√©ances √† cr√©er pour ce jour
                        const sessionsThisDay = Math.ceil(remainingSessions / remainingDays);
                        const actualSessions = Math.min(sessionsThisDay, remainingSessions);
                        
                        // Cr√©er plusieurs s√©ances pour ce jour si n√©cessaire
                        for (let s = 0; s < actualSessions; s++) {
                            sessionCounters[weekNum]++;
                            const seanceData = {
                                seance_num: sessionCounters[weekNum],
                                chapitre: row[4] || '',
                                contenu_lecon: row[5] || '',
                                res_lecon: row[6] || '',
                                devoir: row[7] || '',
                                res_devoir: row[8] || '',
                                recherche: row[9] || '',
                                projet: row[10] || ''
                            };
                            dataByWeek[weekNum].seances.push(seanceData);
                        }
                    }
                }
            } else {
                const weekSeances = dataByWeek[weekNum].seances;
                if (!weekSeances.some(s => s.chapitre === event.type)) {
                    const specialSeance = {
                        seance_num: ' ',
                        chapitre: event.type,
                        contenu_lecon: '',
                        res_lecon: '',
                        devoir: '',
                        res_devoir: '',
                        recherche: '',
                        projet: ''
                    };
                    dataByWeek[weekNum].seances.push(specialSeance);
                }
            }
        });
        
        // Construire le r√©sultat avec les cl√©s bas√©es sur les num√©ros de semaine du calendrier
        // Ex: week2_seances, week4_seances, week7_seances, etc.
        const templateData = {
            class_name: className,
            subject_name: subjectName
        };
        
        // Ajouter chaque semaine avec son num√©ro sp√©cifique
        Object.keys(dataByWeek).forEach(weekNum => {
            const weekData = dataByWeek[weekNum];
            const weekKey = `week${weekNum}`;
            
            // Trier les s√©ances
            const sortedSeances = weekData.seances.sort((a, b) => {
                if (a.seance_num === ' ') return -1;
                if (b.seance_num === ' ') return 1;
                return a.seance_num - b.seance_num;
            });
            
            templateData[`${weekKey}_name`] = weekData.week_name;
            templateData[`${weekKey}_seances`] = sortedSeances;
        });
        
        return templateData;
    }
    
    showInitialSelection();
</script>
</body>
</html>
